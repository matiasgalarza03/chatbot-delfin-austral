import React, {
  useEffect,
  useRef,
  useState,
  useMemo,
  useCallback,
} from "react";
import VisualizadorMultimedia from "./VisualizadorMultimedia";
import audioManagerFinal from "../utils/audioManagerFinal";
import sincronizacionAudio from "../data/SincronizacionAudio.json";
import manualSyncManager from "../utils/manualSyncManager";
import audioSyncDetector from '../utils/audioSyncDetector';

// Clave para localStorage
const ESTILOS_GLOBALES_KEY = "malvin_estilos_globales";

// Funci√≥n para cargar estilos desde localStorage con migraci√≥n autom√°tica
function cargarEstilosGlobales() {
  try {
    const estilosGuardados = localStorage.getItem(ESTILOS_GLOBALES_KEY);
    if (estilosGuardados) {
      const estilos = JSON.parse(estilosGuardados);

      // Migraci√≥n autom√°tica: corregir posiciones muy altas
      if (estilos.bottom && parseFloat(estilos.bottom) > 5) {
        console.log(
          "Migrando posici√≥n antigua a subt√≠tulos:",
          estilos.bottom,
          "‚Üí 1rem",
        );
        estilos.bottom = "1rem";
        // Guardar la correcci√≥n inmediatamente
        localStorage.setItem(ESTILOS_GLOBALES_KEY, JSON.stringify(estilos));
      }

      // Migraci√≥n: asegurar valores m√≠nimos para subt√≠tulos
      if (!estilos.bottom || parseFloat(estilos.bottom) < 0) {
        estilos.bottom = "1rem";
      }
      if (!estilos.marginBottom) {
        estilos.marginBottom = "0.5rem";
      }

      return estilos;
    }
  } catch (error) {
    console.warn("Error cargando estilos desde localStorage:", error);
  }
  return null;
}

// Funci√≥n para guardar estilos en localStorage
function guardarEstilosGlobales(estilos) {
  try {
    localStorage.setItem(ESTILOS_GLOBALES_KEY, JSON.stringify(estilos));
  } catch (error) {
    console.warn("Error guardando estilos en localStorage:", error);
  }
}

// Funci√≥n mejorada para crear bloques de texto correctamente balanceados
function createOptimizedTextBlocks(text) {
  if (!text || text.trim() === '') {
    console.error('Texto vac√≠o o indefinido recibido en createOptimizedTextBlocks');
    return ['Texto no disponible'];
  }

  const cleanText = text.trim();
  
  // NUEVA L√ìGICA: Si el texto es corto (menos de 200 caracteres), no dividir
  if (cleanText.length <= 200) {
    console.log('üìù Texto corto detectado, mostrando como un solo bloque:', cleanText.length, 'caracteres');
    return [cleanText];
  }

  // Configuraci√≥n optimizada para textos largos
  const TARGET_SENTENCES_PER_BLOCK = 2;
  const MAX_CHARS_PER_BLOCK = 220; // Aumentado para mostrar m√°s contenido
  const MIN_CHARS_PER_BLOCK = 40; // Aumentado para evitar fragmentos muy peque√±os

  // Paso 1: Proteger abreviaciones conocidas para evitar divisi√≥n incorrecta
  let processedText = text
    .replace(/\s+/g, " ")
    .trim()
    // Proteger abreviaciones comunes
    .replace(/E\.E\.S\./g, "E_E_S_")
    .replace(/N¬∞(\d+)/g, "N_$1_")
    .replace(/Dr\./g, "Dr_")
    .replace(/Dra\./g, "Dra_")
    .replace(/Prof\./g, "Prof_")
    .replace(/Sr\./g, "Sr_")
    .replace(/Sra\./g, "Sra_");

  // Paso 2: Dividir en oraciones, pero siendo m√°s cuidadoso
  const oraciones = [];
  const matches = processedText.match(/[^.!?]*[.!?]+/g) || [];

  for (let match of matches) {
    oraciones.push(match.trim());
  }

  // Agregar texto final si no termina en puntuaci√≥n
  const textoRestante = processedText.replace(/[^.!?]*[.!?]+/g, "").trim();
  if (textoRestante) {
    oraciones.push(textoRestante + (textoRestante.match(/[.!?]$/) ? "" : "."));
  }

  // Paso 3: Restaurar abreviaciones y limpiar
  const oracionesLimpias = oraciones
    .map((oracion) =>
      oracion
        .trim()
        .replace(/E_E_S_/g, "E.E.S.")
        .replace(/N_(\d+)_/g, "N¬∞$1")
        .replace(/Dr_/g, "Dr.")
        .replace(/Dra_/g, "Dra.")
        .replace(/Prof_/g, "Prof.")
        .replace(/Sr_/g, "Sr.")
        .replace(/Sra_/g, "Sra."),
    )
    .filter((oracion) => oracion.length > 0);

  // Paso 4: Crear bloques inteligentemente
  const bloques = [];
  let bloqueActual = "";
  let contadorOraciones = 0;

  for (let i = 0; i < oracionesLimpias.length; i++) {
    const oracion = oracionesLimpias[i];
    if (!oracion.trim()) continue;

    const bloquePrueba = bloqueActual ? `${bloqueActual} ${oracion}` : oracion;

    // Condiciones para finalizar bloque actual
    const esDemasiadoLargo = bloquePrueba.length > MAX_CHARS_PER_BLOCK;
    const tieneDosSentencias = contadorOraciones >= TARGET_SENTENCES_PER_BLOCK;
    const bloqueActualTieneContenido = bloqueActual.length > 0;

    if (
      (esDemasiadoLargo || tieneDosSentencias) &&
      bloqueActualTieneContenido
    ) {
      bloques.push(bloqueActual.trim());
      bloqueActual = oracion;
      contadorOraciones = 1;
    } else {
      bloqueActual = bloquePrueba;
      contadorOraciones++;
    }
  }

  // Agregar √∫ltimo bloque
  if (bloqueActual.trim()) {
    bloques.push(bloqueActual.trim());
  }

  // Paso 5: Post-procesamiento para optimizar bloques problem√°ticos
  const bloquesOptimizados = [];

  for (let i = 0; i < bloques.length; i++) {
    const bloque = bloques[i];
    const caracteres = bloque.length;
    const palabras = bloque.split(" ").length;

    // Detectar bloques problem√°ticos que necesitan combinaci√≥n
    const esMuyCorto = caracteres < MIN_CHARS_PER_BLOCK || palabras < 6;
    const esFragmentoAbreviacion =
      /^[A-Z]\.\s*N¬∞|^S\.\s*N¬∞|^\w{1,3}[\s.]*$/.test(bloque.trim());
    const esInicioIncompleto =
      bloque.match(/E\.E\.S?\.$/) ||
      bloque.match(/de la E\.$/) ||
      bloque.match(/E\.\s*$/) ||
      bloque.match(/E\.E\.\s*$/);

    // Si es problem√°tico y hay un siguiente bloque, intentar combinar
    if (
      (esMuyCorto || esFragmentoAbreviacion || esInicioIncompleto) &&
      i < bloques.length - 1
    ) {
      const siguienteBloque = bloques[i + 1];
      const combinado = `${bloque} ${siguienteBloque}`.trim();

      // Verificar que la combinaci√≥n sea razonable
      if (combinado.length <= MAX_CHARS_PER_BLOCK * 1.2) {
        bloquesOptimizados.push(combinado);
        i++; // Saltar el siguiente bloque ya que lo combinamos
        continue;
      }
    }

    bloquesOptimizados.push(bloque);
  }

  // Paso 6: Verificaci√≥n final y logging
  const bloquesFinal = bloquesOptimizados
    .filter((bloque) => bloque && bloque.trim().length > 0)
    .map((bloque) => bloque.trim());
  
  console.log('üìä An√°lisis de bloques creados:');
  bloquesFinal.forEach((bloque, index) => {
    console.log(`  Bloque ${index + 1}: ${bloque.length} caracteres - "${bloque.substring(0, 60)}..."`);
  });
  
  return bloquesFinal;
}

// Funci√≥n para calcular tiempo de lectura con 120 palabras por minuto (m√°s lento para mejor lectura)
function calculateReadingTime(text) {
  const wordsPerMinute = 120; // Reducido a√∫n m√°s para dar m√°s tiempo de lectura
  const words = text.split(" ").length;
  const minutes = words / wordsPerMinute;
  // Aumentar el tiempo m√≠nimo a 5 segundos y m√°ximo a 18 segundos
  const seconds = Math.max(5, Math.min(18, Math.ceil(minutes * 60 * 1.8))); // A√±adido 80% m√°s de tiempo
  console.log(`‚è±Ô∏è Tiempo de lectura para ${words} palabras: ${seconds} segundos`);
  return seconds * 1000; // Convertir a milisegundos
}

/**
 * Determina la informaci√≥n de audio basada en la pregunta
 * @param {Object} pregunta - Objeto de pregunta con pregunta y respuesta
 * @returns {Object|null} - Informaci√≥n de audio o null
 */
function determineAudioInfo(pregunta) {
  console.log('üîç INICIANDO MAPEO DE AUDIO');
  console.log('üìù Pregunta completa recibida:', pregunta);
  
  // Obtener el texto de la pregunta
  const preguntaText = pregunta.pregunta?.toLowerCase() || '';
  console.log('üî§ Texto de pregunta procesado:', preguntaText);
  
  // üéØ MAPEO DIRECTO BASADO EN PREGUNTAS EXACTAS DEL JSON
  
  // ===== DELF√çN AUSTRAL =====
  if (preguntaText === '¬°hola!') {
    console.log('‚úÖ MAPEO EXACTO: delfin_austral -> presentacion');
    return { categoria: 'delfin_austral', identificador: 'presentacion' };
  }
  if (preguntaText === '¬øqu√© eres?') {
    console.log('‚úÖ MAPEO EXACTO: delfin_austral -> naturaleza');
    return { categoria: 'delfin_austral', identificador: 'naturaleza' };
  }
  if (preguntaText === '¬øpara qu√© fuiste creado?') {
    console.log('‚úÖ MAPEO EXACTO: delfin_austral -> proposito');
    return { categoria: 'delfin_austral', identificador: 'proposito' };
  }
  if (preguntaText === '¬øqu√© puedes hacer?') {
    console.log('‚úÖ MAPEO EXACTO: delfin_austral -> funcionalidades');
    return { categoria: 'delfin_austral', identificador: 'funcionalidades' };
  }
  
  // ===== ESCUELA SECUNDARIA =====
  if (preguntaText === '¬øcu√°ndo se fund√≥ la escuela y d√≥nde se encuentra ubicada?') {
    console.log('‚úÖ MAPEO EXACTO: escuela_secundaria -> historia_ubicacion');
    return { categoria: 'escuela_secundaria', identificador: 'historia_ubicacion' };
  }
  if (preguntaText.includes('por qu√© se llama "malvinas argentinas"')) {
    console.log('‚úÖ MAPEO EXACTO: escuela_secundaria -> nombre_proyectos');
    return { categoria: 'escuela_secundaria', identificador: 'nombre_proyectos' };
  }
  if (preguntaText.includes('qui√©nes dise√±aron el logo')) {
    console.log('‚úÖ MAPEO EXACTO: escuela_secundaria -> logo_bandera');
    return { categoria: 'escuela_secundaria', identificador: 'logo_bandera' };
  }
  if (preguntaText.includes('qui√©nes forman el equipo directivo')) {
    console.log('‚úÖ MAPEO EXACTO: escuela_secundaria -> equipo_directivo');
    return { categoria: 'escuela_secundaria', identificador: 'equipo_directivo' };
  }
  if (preguntaText.includes('cuenta con espacios dedicados')) {
    console.log('‚úÖ MAPEO EXACTO: escuela_secundaria -> espacios_educativos');
    return { categoria: 'escuela_secundaria', identificador: 'espacios_educativos' };
  }
  
  // ===== MUSEO ESCOLAR - MAPEO MEJORADO =====
  console.log('üèõÔ∏è Verificando preguntas de Museo Escolar...');
  
  // Mapeo exacto basado en las preguntas del JSON
  if (preguntaText === '¬øqu√© es el museo escolar?') {
    console.log('‚úÖ MAPEO EXACTO: museo_escolar -> definicion');
    return { categoria: 'museo_escolar', identificador: 'definicion' };
  }
  if (preguntaText.includes('cu√°les son los objetivos del museo')) {
    console.log('‚úÖ MAPEO EXACTO: museo_escolar -> objetivos');
    return { categoria: 'museo_escolar', identificador: 'objetivos' };
  }
  if (preguntaText.includes('qu√© actividades se realizan')) {
    console.log('‚úÖ MAPEO EXACTO: museo_escolar -> actividades');
    return { categoria: 'museo_escolar', identificador: 'actividades' };
  }
  if (preguntaText.includes('qu√© recursos est√°n disponibles')) {
    console.log('‚úÖ MAPEO EXACTO: museo_escolar -> recursos');
    return { categoria: 'museo_escolar', identificador: 'recursos' };
  }
  
  // Mapeo por palabras clave para museo escolar
  if (preguntaText.includes('museo')) {
    console.log('üéØ DETECTADO: Pregunta contiene "museo" - Aplicando mapeo por palabras clave');
    
    if (preguntaText.includes('qu√© es') || preguntaText.includes('que es') || preguntaText.includes('definici√≥n')) {
      console.log('‚úÖ MAPEO POR CLAVE: museo_escolar -> definicion');
      return { categoria: 'museo_escolar', identificador: 'definicion' };
    }
    if (preguntaText.includes('objetivo') || preguntaText.includes('objetivos') || preguntaText.includes('prop√≥sito')) {
      console.log('‚úÖ MAPEO POR CLAVE: museo_escolar -> objetivos');
      return { categoria: 'museo_escolar', identificador: 'objetivos' };
    }
    if (preguntaText.includes('actividad') || preguntaText.includes('actividades') || preguntaText.includes('hace')) {
      console.log('‚úÖ MAPEO POR CLAVE: museo_escolar -> actividades');
      return { categoria: 'museo_escolar', identificador: 'actividades' };
    }
    if (preguntaText.includes('recurso') || preguntaText.includes('recursos') || preguntaText.includes('disponible')) {
      console.log('‚úÖ MAPEO POR CLAVE: museo_escolar -> recursos');
      return { categoria: 'museo_escolar', identificador: 'recursos' };
    }
    
    // Si contiene "museo" pero no coincide con patrones espec√≠ficos, usar el primer audio
    console.log('‚ö†Ô∏è MAPEO DE EMERGENCIA: museo_escolar -> definicion (por defecto)');
    return { categoria: 'museo_escolar', identificador: 'definicion' };
  }
  
  // ===== MAPEO ALTERNATIVO POR PALABRAS CLAVE =====
  
  // Delf√≠n Austral - mapeo alternativo
  if (preguntaText.includes('hola') || preguntaText.includes('saludo') || preguntaText.includes('presentaci√≥n')) {
    console.log('‚úÖ MAPEO ALTERNATIVO: delfin_austral -> presentacion');
    return { categoria: 'delfin_austral', identificador: 'presentacion' };
  }
  if (preguntaText.includes('qu√© eres') || preguntaText.includes('que eres') || preguntaText.includes('naturaleza')) {
    console.log('‚úÖ MAPEO ALTERNATIVO: delfin_austral -> naturaleza');
    return { categoria: 'delfin_austral', identificador: 'naturaleza' };
  }
  if (preguntaText.includes('para qu√©') || preguntaText.includes('prop√≥sito') || preguntaText.includes('creado')) {
    console.log('‚úÖ MAPEO ALTERNATIVO: delfin_austral -> proposito');
    return { categoria: 'delfin_austral', identificador: 'proposito' };
  }
  if (preguntaText.includes('puedes hacer') || preguntaText.includes('funcionalidades') || preguntaText.includes('capacidades')) {
    console.log('‚úÖ MAPEO ALTERNATIVO: delfin_austral -> funcionalidades');
    return { categoria: 'delfin_austral', identificador: 'funcionalidades' };
  }
  
  // Escuela Secundaria - mapeo alternativo
  if (preguntaText.includes('fund√≥') || preguntaText.includes('ubicada') || preguntaText.includes('historia')) {
    console.log('‚úÖ MAPEO ALTERNATIVO: escuela_secundaria -> historia_ubicacion');
    return { categoria: 'escuela_secundaria', identificador: 'historia_ubicacion' };
  }
  if (preguntaText.includes('malvinas argentinas') || preguntaText.includes('nombre') || preguntaText.includes('proyectos')) {
    console.log('‚úÖ MAPEO ALTERNATIVO: escuela_secundaria -> nombre_proyectos');
    return { categoria: 'escuela_secundaria', identificador: 'nombre_proyectos' };
  }
  if (preguntaText.includes('logo') || preguntaText.includes('bandera') || preguntaText.includes('dise√±aron')) {
    console.log('‚úÖ MAPEO ALTERNATIVO: escuela_secundaria -> logo_bandera');
    return { categoria: 'escuela_secundaria', identificador: 'logo_bandera' };
  }
  if (preguntaText.includes('equipo directivo') || preguntaText.includes('directivo') || preguntaText.includes('director')) {
    console.log('‚úÖ MAPEO ALTERNATIVO: escuela_secundaria -> equipo_directivo');
    return { categoria: 'escuela_secundaria', identificador: 'equipo_directivo' };
  }
  if (preguntaText.includes('espacios') || preguntaText.includes('educativos') || preguntaText.includes('instalaciones')) {
    console.log('‚úÖ MAPEO ALTERNATIVO: escuela_secundaria -> espacios_educativos');
    return { categoria: 'escuela_secundaria', identificador: 'espacios_educativos' };
  }
  
  // ===== MALVINAS - MAPEO COMPLETO PARA LAS 4 SUBSECCIONES =====
  
  // 1. Contexto Geogr√°fico Hist√≥rico - malvinas_contexto_geografico
  if (preguntaText.includes('contexto geogr√°fico') || preguntaText.includes('contexto geografico')) {
    console.log('‚úÖ MAPEO: malvinas_contexto_geografico -> historia');
    return { categoria: 'malvinas_contexto_geografico', identificador: 'historia' };
  }
  if (preguntaText.includes('descubrimiento') || preguntaText.includes('descubiertas') || preguntaText.includes('descubri√≥')) {
    console.log('‚úÖ MAPEO: malvinas_contexto_geografico -> descubrimiento');
    return { categoria: 'malvinas_contexto_geografico', identificador: 'descubrimiento' };
  }
  if (preguntaText.includes('historia') && preguntaText.includes('malvinas')) {
    console.log('‚úÖ MAPEO: malvinas_contexto_geografico -> historia');
    return { categoria: 'malvinas_contexto_geografico', identificador: 'historia' };
  }
  if (preguntaText.includes('bandera') && preguntaText.includes('malvinas')) {
    console.log('‚úÖ MAPEO: malvinas_contexto_geografico -> bandera');
    return { categoria: 'malvinas_contexto_geografico', identificador: 'bandera' };
  }
  if (preguntaText.includes('luis vernet') || (preguntaText.includes('fundador') && preguntaText.includes('malvinas'))) {
    console.log('‚úÖ MAPEO: malvinas_contexto_geografico -> fundador');
    return { categoria: 'malvinas_contexto_geografico', identificador: 'fundador' };
  }
  if (preguntaText.includes('primer gobernador') || preguntaText.includes('james onslow')) {
    console.log('‚úÖ MAPEO: malvinas_contexto_geografico -> primer_gobernador');
    return { categoria: 'malvinas_contexto_geografico', identificador: 'primer_gobernador' };
  }
  if (preguntaText.includes('flora') && preguntaText.includes('malvinas')) {
    console.log('‚úÖ MAPEO: malvinas_contexto_geografico -> flora');
    return { categoria: 'malvinas_contexto_geografico', identificador: 'flora' };
  }
  if (preguntaText.includes('fauna') && preguntaText.includes('malvinas')) {
    console.log('‚úÖ MAPEO: malvinas_contexto_geografico -> fauna');
    return { categoria: 'malvinas_contexto_geografico', identificador: 'fauna' };
  }
  if (preguntaText.includes('actividades econ√≥micas') || (preguntaText.includes('econom√≠a') && preguntaText.includes('malvinas'))) {
    console.log('‚úÖ MAPEO: malvinas_contexto_geografico -> actividades_economicas');
    return { categoria: 'malvinas_contexto_geografico', identificador: 'actividades_economicas' };
  }
  
  // 2. Conflicto Armado 1982 - malvinas_conflicto_armado
  if (preguntaText.includes('conflicto armado') || preguntaText.includes('guerra de 1982') || preguntaText.includes('guerra malvinas')) {
    console.log('‚úÖ MAPEO: malvinas_conflicto_armado -> inicio_conflicto');
    return { categoria: 'malvinas_conflicto_armado', identificador: 'inicio_conflicto' };
  }
  if (preguntaText.includes('inicio') && (preguntaText.includes('conflicto') || preguntaText.includes('guerra'))) {
    console.log('‚úÖ MAPEO: malvinas_conflicto_armado -> inicio_conflicto');
    return { categoria: 'malvinas_conflicto_armado', identificador: 'inicio_conflicto' };
  }
  if (preguntaText.includes('conflictos destacados') || preguntaText.includes('batallas importantes')) {
    console.log('‚úÖ MAPEO: malvinas_conflicto_armado -> conflictos_destacados');
    return { categoria: 'malvinas_conflicto_armado', identificador: 'conflictos_destacados' };
  }
  if (preguntaText.includes('conclusi√≥n') && preguntaText.includes('guerra')) {
    console.log('‚úÖ MAPEO: malvinas_conflicto_armado -> conclusion_guerra');
    return { categoria: 'malvinas_conflicto_armado', identificador: 'conclusion_guerra' };
  }
  if (preguntaText.includes('belgrano') || preguntaText.includes('impacto belgrano')) {
    console.log('‚úÖ MAPEO: malvinas_conflicto_armado -> impacto_belgrano');
    return { categoria: 'malvinas_conflicto_armado', identificador: 'impacto_belgrano' };
  }
  if (preguntaText.includes('armamento') || preguntaText.includes('armas utilizadas')) {
    console.log('‚úÖ MAPEO: malvinas_conflicto_armado -> armamento');
    return { categoria: 'malvinas_conflicto_armado', identificador: 'armamento' };
  }
  if (preguntaText.includes('arma m√°s efectiva') || preguntaText.includes('exocet')) {
    console.log('‚úÖ MAPEO: malvinas_conflicto_armado -> arma_mas_efectiva');
    return { categoria: 'malvinas_conflicto_armado', identificador: 'arma_mas_efectiva' };
  }
  if (preguntaText.includes('h√©roes') || preguntaText.includes('heroes')) {
    console.log('‚úÖ MAPEO: malvinas_conflicto_armado -> heroes');
    return { categoria: 'malvinas_conflicto_armado', identificador: 'heroes' };
  }
  if (preguntaText.includes('rol') && preguntaText.includes('pilotos')) {
    console.log('‚úÖ MAPEO: malvinas_conflicto_armado -> rol_pilotos');
    return { categoria: 'malvinas_conflicto_armado', identificador: 'rol_pilotos' };
  }
  if (preguntaText.includes('desaf√≠os') && preguntaText.includes('pilotos')) {
    console.log('‚úÖ MAPEO: malvinas_conflicto_armado -> desafios_pilotos');
    return { categoria: 'malvinas_conflicto_armado', identificador: 'desafios_pilotos' };
  }
  
  // üéØ MAPEO ESPEC√çFICO PARA SUBSECCI√ìN "DESARROLLO Y CONSECUENCIAS DEL CONFLICTO"
  if (preguntaText.includes('principales sectores geogr√°ficos') || preguntaText.includes('sectores geogr√°ficos') || preguntaText.includes('Sectores') || preguntaText.includes('Geogr√°ficos')) {
    console.log('üö® AUDIO DEBUG: MAPEO DETECTADO para sectores geogr√°ficos');
    console.log('üîç Pregunta detectada:', preguntaText);
    console.log('üéµ Deber√≠a reproducir: 21_principales_sectores_geogr√°ficos.mp3');
    console.log('üìÅ Archivo debe estar en: /audios/respuestas_predefinidas/malvinas/conflicto_armado/');
    return { categoria: 'malvinas_desarrollo_conflicto', identificador: 'principales_sectores' };
  }
  if (preguntaText.includes('desarrollo del conflicto') || preguntaText.includes('desarrollo conflicto')) {
    console.log('‚úÖ MAPEO: malvinas_conflicto_armado -> desarrollo_conflicto');
    return { categoria: 'malvinas_conflicto_armado', identificador: 'desarrollo_conflicto' };
  }
  if (preguntaText.includes('consecuencias del conflicto') || preguntaText.includes('consecuencias conflicto')) {
    console.log('‚úÖ MAPEO: malvinas_conflicto_armado -> consecuencias_conflicto');
    return { categoria: 'malvinas_conflicto_armado', identificador: 'consecuencias_conflicto' };
  }
  if (preguntaText.includes('batallas destacadas') || preguntaText.includes('batallas m√°s destacadas')) {
    console.log('‚úÖ MAPEO: malvinas_conflicto_armado -> batallas_destacadas');
    return { categoria: 'malvinas_conflicto_armado', identificador: 'batallas_destacadas' };
  }
  if (preguntaText.includes('armamento utilizado') || preguntaText.includes('tipo de armamento')) {
    console.log('‚úÖ MAPEO: malvinas_conflicto_armado -> armamento_utilizado');
    return { categoria: 'malvinas_conflicto_armado', identificador: 'armamento_utilizado' };
  }
  
  // 3. Impacto Social y Cultural - malvinas_impacto_social
  if (preguntaText.includes('impacto social') || preguntaText.includes('impacto cultural')) {
    console.log('‚úÖ MAPEO: malvinas_impacto_social -> respuesta_social');
    return { categoria: 'malvinas_impacto_social', identificador: 'respuesta_social' };
  }
  if (preguntaText.includes('relato durante') || preguntaText.includes('durante conflicto')) {
    console.log('‚úÖ MAPEO: malvinas_impacto_social -> relato_durante_conflicto');
    return { categoria: 'malvinas_impacto_social', identificador: 'relato_durante_conflicto' };
  }
  if (preguntaText.includes('medios locales') || preguntaText.includes('prensa local')) {
    console.log('‚úÖ MAPEO: malvinas_impacto_social -> medios_locales');
    return { categoria: 'malvinas_impacto_social', identificador: 'medios_locales' };
  }
  if (preguntaText.includes('peri√≥dicos argentinos') || preguntaText.includes('periodicos argentinos')) {
    console.log('‚úÖ MAPEO: malvinas_impacto_social -> periodicos_argentinos');
    return { categoria: 'malvinas_impacto_social', identificador: 'periodicos_argentinos' };
  }
  if (preguntaText.includes('cartas') && preguntaText.includes('soldados')) {
    console.log('‚úÖ MAPEO: malvinas_impacto_social -> participacion_estudiantil');
    return { categoria: 'malvinas_impacto_social', identificador: 'participacion_estudiantil' };
  }
  if (preguntaText.includes('donaciones') || preguntaText.includes('respuesta social')) {
    console.log('‚úÖ MAPEO: malvinas_impacto_social -> respuesta_social');
    return { categoria: 'malvinas_impacto_social', identificador: 'respuesta_social' };
  }
  if (preguntaText.includes('veteranos') || preguntaText.includes('relatos veteranos')) {
    console.log('‚úÖ MAPEO: malvinas_impacto_social -> relatos_veteranos');
    return { categoria: 'malvinas_impacto_social', identificador: 'relatos_veteranos' };
  }
  
  // 4. Legado y Realidad Actual - malvinas_legado_actual
  if (preguntaText.includes('legado') || preguntaText.includes('realidad actual')) {
    console.log('‚úÖ MAPEO: malvinas_legado_actual -> situacion_actual');
    return { categoria: 'malvinas_legado_actual', identificador: 'situacion_actual' };
  }
  if (preguntaText.includes('situaci√≥n actual') || preguntaText.includes('situacion actual')) {
    console.log('‚úÖ MAPEO: malvinas_legado_actual -> situacion_actual');
    return { categoria: 'malvinas_legado_actual', identificador: 'situacion_actual' };
  }
  if (preguntaText.includes('cementerio') || preguntaText.includes('darwin')) {
    console.log('‚úÖ MAPEO: malvinas_legado_actual -> creacion');
    return { categoria: 'malvinas_legado_actual', identificador: 'creacion' };
  }
  if (preguntaText.includes('identificaci√≥n') && preguntaText.includes('restos')) {
    console.log('‚úÖ MAPEO: malvinas_legado_actual -> identificacion_restos');
    return { categoria: 'malvinas_legado_actual', identificador: 'identificacion_restos' };
  }
  if (preguntaText.includes('pesca') || preguntaText.includes('importancia econ√≥mica')) {
    console.log('‚úÖ MAPEO: malvinas_legado_actual -> importancia_economica');
    return { categoria: 'malvinas_legado_actual', identificador: 'importancia_economica' };
  }
  if (preguntaText.includes('relaciones') && (preguntaText.includes('brit√°nicas') || preguntaText.includes('britanicas'))) {
    console.log('‚úÖ MAPEO: malvinas_legado_actual -> relaciones_argentino_britanicas');
    return { categoria: 'malvinas_legado_actual', identificador: 'relaciones_argentino_britanicas' };
  }
  
  // Mapeo gen√©rico para Malvinas (por subsecci√≥n m√°s probable)
  if (preguntaText.includes('malvinas') && !preguntaText.includes('escuela') && !preguntaText.includes('argentinas')) {
    console.log('‚úÖ MAPEO GEN√âRICO: Detectada pregunta sobre Malvinas -> contexto_geografico/historia');
    return { categoria: 'malvinas_contexto_geografico', identificador: 'historia' };
  }
  
  console.log('üéµ ‚ùå NO SE ENCONTR√ì MAPEO DE AUDIO PARA:', pregunta.pregunta);
  console.log('üîç Texto procesado:', preguntaText);
  return null;
}

export default function RespuestaPredefinida({
  pregunta,
  onVolver,
  onRespuestaCompleta,
  onVisualizadorAbierto,
  onShowInventoryModal,
}) {
  // Validaci√≥n temprana para evitar errores
  if (!pregunta || !pregunta.pregunta || !pregunta.respuesta) {
    console.error('‚ùå RespuestaPredefinida: Datos de pregunta inv√°lidos:', pregunta);
    return null;
  }
  const [currentIdx, setCurrentIdx] = useState(0);
  const [mostrarVisualizador, setMostrarVisualizador] = useState(false);
  const [modoEdicion, setModoEdicion] = useState(false);
  const [audioSyncDuration, setAudioSyncDuration] = useState(null); // Duraci√≥n real del audio
  const [respuestaEnProceso, setRespuestaEnProceso] = useState(false); // Evitar m√∫ltiples llamadas
  
  // üéØ ESTADOS PARA SINCRONIZACI√ìN MANUAL
  const [modoSincronizacionManual, setModoSincronizacionManual] = useState(false);
  const [ajusteManualActual, setAjusteManualActual] = useState(0);
  const [mostrarIndicadorAjuste, setMostrarIndicadorAjuste] = useState(false);
  const [audioStarted, setAudioStarted] = useState(false); // Controlar inicio de subt√≠tulos
  
  // Detectar si es la pregunta del buscador de inventario
  const esBuscadorInventario = pregunta && (
    (pregunta.pregunta && pregunta.pregunta.includes("Buscador de art√≠culos del Inventario")) ||
    pregunta.isInventorySearch
  );
  
  // Abrir modal del inventario si es la pregunta correspondiente
  useEffect(() => {
    if (esBuscadorInventario && onShowInventoryModal) {
      console.log('üèõÔ∏è Detectado buscador de inventario, abriendo modal en 1 segundo...');
      // Peque√±o delay para que se vea la respuesta antes de abrir el modal
      const timer = setTimeout(() => {
        console.log('üèõÔ∏è Abriendo modal de inventario ahora...');
        onShowInventoryModal();
      }, 1000); // 1 segundo despu√©s de mostrar la respuesta
      
      return () => clearTimeout(timer);
    }
  }, [esBuscadorInventario, onShowInventoryModal]);
  
  const [textosEditados, setTextosEditados] = useState({});
  const [edicionGlobal, setEdicionGlobal] = useState(true);
  const [estilosGlobales, setEstilosGlobales] = useState(() => {
    const estilosGuardados = cargarEstilosGlobales();
    return (
      estilosGuardados || {
        width: "900px",
        fontSize: "1.6rem",
        lineHeight: "1.4",
        bottom: "1rem",
        marginBottom: "0.5rem",
      }
    );
  });
  const [estilosIndividuales, setEstilosIndividuales] = useState({});

  const estilosDefecto = {
    width: "900px",
    fontSize: "1.6rem",
    lineHeight: "1.4",
    bottom: "1rem",
    marginBottom: "0.5rem",
  };

  // Obtener estilos actuales (globales o individuales)
  const estilosActuales = edicionGlobal
    ? estilosGlobales
    : estilosIndividuales[currentIdx] || estilosGlobales;

  // Crear bloques optimizados
  const textBlocks = useMemo(() => {
    const blocks = createOptimizedTextBlocks(pregunta.respuesta);
    console.log(`üìù Respuesta dividida en ${blocks.length} bloques:`, blocks);
    return blocks;
  }, [pregunta.respuesta]);

  const currentBlock = textBlocks[currentIdx] || "";
  const currentDisplayText = textosEditados[currentIdx] || currentBlock;
  const advanceTimeout = useRef();
  const shiftPressCount = useRef(0);
  const shiftTimer = useRef(null);


  // üéµ SISTEMA DE AUDIO FINAL CON SINCRONIZACI√ìN ESPEC√çFICA
  const [lastProcessedQuestion, setLastProcessedQuestion] = useState('');
  const audioProcessingRef = useRef(false); // Bandera para evitar ejecuciones m√∫ltiples
  const [sincronizacionEspecifica, setSincronizacionEspecifica] = useState(null);
  
  // üéØ Funci√≥n para obtener configuraci√≥n de sincronizaci√≥n espec√≠fica
  const obtenerSincronizacion = useCallback((pregunta) => {
    const q = pregunta.pregunta.toLowerCase().trim();
    
    // Mapeo de preguntas a claves de sincronizaci√≥n
    const mapeoSincronizacion = {
      // Delf√≠n Austral
      '¬°hola!': { categoria: 'delfin_austral', clave: 'presentacion' },
      '¬øqu√© eres?': { categoria: 'delfin_austral', clave: 'naturaleza' },
      '¬øpara qu√© fuiste creado?': { categoria: 'delfin_austral', clave: 'proposito' },
      '¬øqu√© puedes hacer?': { categoria: 'delfin_austral', clave: 'funcionalidades' },
      
      // Escuela Secundaria
      '¬øcu√°ndo se fund√≥ la escuela y d√≥nde se encuentra ubicada?': { categoria: 'escuela_secundaria', clave: 'historia_ubicacion' },
      '¬øpor qu√© se llama "malvinas argentinas" y qu√© proyectos importantes ha desarrollado?': { categoria: 'escuela_secundaria', clave: 'nombre_proyectos' },
      '¬øla escuela cuenta con espacios dedicados a exhibir su historia y trabajos estudiantiles?': { categoria: 'escuela_secundaria', clave: 'espacios_historia_trabajos' },
      '¬øqui√©nes dise√±aron el logo y la bandera de la escuela y qu√© simbolizan?': { categoria: 'escuela_secundaria', clave: 'logo_bandera' },
      '¬øqui√©nes forman el equipo directivo de la escuela?': { categoria: 'escuela_secundaria', clave: 'equipo_directivo' },
      '¬øla escuela cuenta con espacios dedicados a la educaci√≥n t√©cnica?': { categoria: 'escuela_secundaria', clave: 'espacios_educativos' },
      
      // Museo Escolar
      '¬øqu√© es el museo escolar?': { categoria: 'museo_escolar', clave: 'definicion' },
      '¬øcu√°les son los objetivos del museo escolar?': { categoria: 'museo_escolar', clave: 'objetivos' },
      '¬øqu√© actividades se realizan en el museo escolar?': { categoria: 'museo_escolar', clave: 'actividades' },
      '¬øqu√© recursos est√°n disponibles en el museo escolar?': { categoria: 'museo_escolar', clave: 'recursos' },
      
      // Malvinas - Contexto Geogr√°fico Hist√≥rico
      '¬øqui√©n descubri√≥ las islas malvinas?': { categoria: 'malvinas_contexto_geografico', clave: 'descubrimiento' },
      '¬øcu√°l es la historia territorial de las malvinas antes de 1982?': { categoria: 'malvinas_contexto_geografico', clave: 'historia' },
      '¬øcual es la bandera actual de las islas malvinas?': { categoria: 'malvinas_contexto_geografico', clave: 'bandera' },
      '¬øqui√©n es considerado el fundador de la presencia argentina en malvinas?': { categoria: 'malvinas_contexto_geografico', clave: 'fundador' },
      '¬øqui√©n fue el primer gobernador brit√°nico de las malvinas?': { categoria: 'malvinas_contexto_geografico', clave: 'primer_gobernador' },
      '¬øqu√© tipos de plantas existen en las islas malvinas?': { categoria: 'malvinas_contexto_geografico', clave: 'flora' },
      '¬øqu√© animales habitan en las malvinas?': { categoria: 'malvinas_contexto_geografico', clave: 'fauna' },
      '¬øcu√°les son las principales actividades econ√≥micas de las malvinas?': { categoria: 'malvinas_contexto_geografico', clave: 'actividades_economicas' },
      
      // Malvinas - Desarrollo y Consecuencias del Conflicto Armado (1982)
      '¬øcu√°ndo comenz√≥ la guerra de malvinas?': { categoria: 'malvinas_desarrollo_conflicto', clave: 'inicio_conflicto' },
      '¬øcu√°ndo y c√≥mo comenz√≥ la guerra de malvinas?': { categoria: 'malvinas_desarrollo_conflicto', clave: 'inicio_conflicto' },
      '¬øcu√°ndo termin√≥ el conflicto?': { categoria: 'malvinas_desarrollo_conflicto', clave: 'consecuencias_conflicto' },
      '¬øc√≥mo se desarroll√≥ el conflicto?': { categoria: 'malvinas_desarrollo_conflicto', clave: 'desarrollo_conflicto' },
      '¬øcu√°les fueron las batallas m√°s importantes?': { categoria: 'malvinas_desarrollo_conflicto', clave: 'batallas_destacadas' },
      '¬øqu√© armamento se utiliz√≥ en la guerra?': { categoria: 'malvinas_desarrollo_conflicto', clave: 'armamento_utilizado' },
      '¬øcu√°l fue el impacto del hundimiento del ara general belgrano?': { categoria: 'malvinas_conflicto_armado', clave: 'impacto_belgrano' },
      '¬øqu√© armamento utilizaron argentina y reino unido durante la guerra de malvinas?': { categoria: 'malvinas_conflicto_armado', clave: 'armamento' },
      '¬øcu√°l fue el arma m√°s efectiva de argentina?': { categoria: 'malvinas_conflicto_armado', clave: 'arma_mas_efectiva' },
      '¬øqui√©nes son considerados h√©roes en la guerra de malvinas?': { categoria: 'malvinas_conflicto_armado', clave: 'heroes' },
      '¬øcu√°l fue el rol de los pilotos argentinos en el conflicto?': { categoria: 'malvinas_conflicto_armado', clave: 'rol_pilotos' },
      '¬øqu√© desaf√≠os enfrentaron los pilotos durante las operaciones?': { categoria: 'malvinas_conflicto_armado', clave: 'desafios_pilotos' },
      '¬øcu√°ntas bajas y heridos hubo en ambos bandos durante la guerra?': { categoria: 'malvinas_conflicto_armado', clave: 'bajas_heridos' },
      '¬øc√≥mo se financiaron argentina y reino unido durante el conflicto?': { categoria: 'malvinas_conflicto_armado', clave: 'suministros_economicos' },
      '¬øhubo sanciones econ√≥micas durante la guerra?': { categoria: 'malvinas_conflicto_armado', clave: 'sanciones_economicas' },
      '¬øcu√°les son los principales sectores geogr√°ficos de las islas malvinas?': { categoria: 'malvinas_desarrollo_conflicto', clave: 'principales_sectores' },
      '¬øparticiparon perros en la guerra de malvinas?': { categoria: 'malvinas_conflicto_armado', clave: 'participacion_perros' },
      '¬øpor qu√© no se menciona su participaci√≥n en muchos relatos hist√≥ricos?': { categoria: 'malvinas_conflicto_armado', clave: 'memoria_historica_perros' },
      
      // Malvinas - Impacto Social y Cultural
      '¬øc√≥mo se informaba sobre la guerra de malvinas en argentina mientras ocurr√≠a?': { categoria: 'malvinas_impacto_social', clave: 'relato_durante_conflicto' },
      '¬øqu√© rol jugaron los medios locales frente a la censura nacional?': { categoria: 'malvinas_impacto_social', clave: 'medios_locales' },
      '¬øc√≥mo retrataron los peri√≥dicos argentinos la guerra de malvinas?': { categoria: 'malvinas_impacto_social', clave: 'periodicos_argentinos' },
      '¬øhubo diferencias entre medios nacionales y regionales?': { categoria: 'malvinas_impacto_social', clave: 'diferencias_regionales' },
      '¬øc√≥mo respondi√≥ la sociedad argentina con donaciones durante la guerra?': { categoria: 'malvinas_impacto_social', clave: 'respuesta_social' },
      '¬øqu√© simbolizaban estas donaciones para la sociedad?': { categoria: 'malvinas_impacto_social', clave: 'simbolismo' },
      '¬øc√≥mo participaron los estudiantes argentinos mediante cartas durante la guerra de malvinas?': { categoria: 'malvinas_impacto_social', clave: 'participacion_estudiantil' },
      '¬øqu√© simbolizaban estas cartas para los soldados?': { categoria: 'malvinas_impacto_social', clave: 'simbolismo_soldados' },
      '¬øqu√© relatos contienen las cartas escritas por veteranos de la guerra?': { categoria: 'malvinas_impacto_social', clave: 'relatos_veteranos' },
      '¬øc√≥mo afectaron estas cartas a las familias?': { categoria: 'malvinas_impacto_social', clave: 'impacto_familias' },
      '¬øqu√© cartas dejaron los soldados que murieron en combate?': { categoria: 'malvinas_impacto_social', clave: 'ultimas_cartas' },
      '¬øc√≥mo se preservan hoy estas cartas?': { categoria: 'malvinas_impacto_social', clave: 'preservacion' },
      '¬øc√≥mo comunicaban los familiares su apoyo a los soldados en malvinas?': { categoria: 'malvinas_impacto_social', clave: 'comunicacion_apoyo' },
      '¬øqu√© dificultades enfrentaron para mantener contacto?': { categoria: 'malvinas_impacto_social', clave: 'dificultades_contacto' },
      
      // Malvinas - Legado y Realidad Actual
      '¬øcu√°l es la situaci√≥n actual de las islas malvinas?': { categoria: 'malvinas_legado_actual', clave: 'situacion_actual' },
      '¬øc√≥mo y cu√°ndo se cre√≥ el cementerio de darwin en malvinas?': { categoria: 'malvinas_legado_actual', clave: 'creacion' },
      '¬øc√≥mo se identificaron los restos de los soldados argentinos en darwin?': { categoria: 'malvinas_legado_actual', clave: 'identificacion_restos' },
      '¬øcu√°l es la importancia de la pesca en las islas malvinas?': { categoria: 'malvinas_legado_actual', clave: 'importancia_economica' },
      '¬øc√≥mo afecta esto a las relaciones argentino-brit√°nicas?': { categoria: 'malvinas_legado_actual', clave: 'relaciones_argentino_britanicas' }
    };
    
    const mapeo = mapeoSincronizacion[q];
    if (mapeo && sincronizacionAudio[mapeo.categoria] && sincronizacionAudio[mapeo.categoria][mapeo.clave]) {
      console.log('üéØ Sincronizaci√≥n espec√≠fica encontrada:', mapeo);
      return sincronizacionAudio[mapeo.categoria][mapeo.clave];
    }
    
    console.log('‚ö†Ô∏è No se encontr√≥ sincronizaci√≥n espec√≠fica para:', q);
    return null;
  }, []);
  
  useEffect(() => {
    if (!pregunta?.pregunta) return;
    
    // üö´ EVITAR EJECUCIONES M√öLTIPLES - DOBLE PROTECCI√ìN
    if (pregunta.pregunta === lastProcessedQuestion) {
      console.log('üö´ PREGUNTA YA PROCESADA, IGNORANDO');
      return;
    }
    
    if (audioProcessingRef.current) {
      console.log('üö´ AUDIO YA EN PROCESAMIENTO, IGNORANDO');
      return;
    }
    
    console.log('üéµ === PROCESANDO NUEVA PREGUNTA CON SINCRONIZACI√ìN ESPEC√çFICA ===');
    console.log('üìù Pregunta:', pregunta.pregunta);
    
    // Marcar como en procesamiento
    audioProcessingRef.current = true;
    setLastProcessedQuestion(pregunta.pregunta);
    
    // üéØ Obtener configuraci√≥n de sincronizaci√≥n espec√≠fica
    const configSincronizacion = obtenerSincronizacion(pregunta);
    setSincronizacionEspecifica(configSincronizacion);
    
    // üéµ REPRODUCIR AUDIO CON SISTEMA FINAL
    audioManagerFinal.play(
      pregunta,
      // onLoaded
      (duration) => {
        if (configSincronizacion) {
          console.log('üéØ Usando sincronizaci√≥n espec√≠fica - Duraci√≥n:', configSincronizacion.duracionTotal + 'ms');
          setAudioSyncDuration(configSincronizacion.duracionTotal);
        } else {
          console.log('‚ö†Ô∏è Usando duraci√≥n de audio detectada:', duration * 1000 + 'ms');
          setAudioSyncDuration(duration * 1000);
        }
        setAudioStarted(true);
        console.log('üéµ ‚úÖ AUDIO √öNICO CARGADO CON SINCRONIZACI√ìN');
        audioProcessingRef.current = false; // Marcar como completado
      },
      // onEnded
      () => {
        console.log('üéµ Audio terminado naturalmente');
        setAudioStarted(false);
        setSincronizacionEspecifica(null);
        audioProcessingRef.current = false; // Marcar como completado
      }
    ).catch(error => {
      console.error('‚ùå Error reproduciendo audio:', error);
      setSincronizacionEspecifica(null);
      audioProcessingRef.current = false; // Marcar como completado en caso de error
    });
    
  }, [pregunta.pregunta, obtenerSincronizacion]); // ‚úÖ SOLO pregunta.pregunta como dependencia

  // Detector de doble Shift para modo edici√≥n
  const handleKeyDown = useCallback((event) => {
    if (event.key === "Shift") {
      shiftPressCount.current += 1;

      if (shiftTimer.current) {
        clearTimeout(shiftTimer.current);
      }

      if (shiftPressCount.current === 2) {
        const nuevoModoEdicion = !modoEdicion;
        
        // Si estamos saliendo del modo edici√≥n, guardar cambios
        if (modoEdicion && !nuevoModoEdicion) {
          guardarCambiosPermanentes();
        }
        
        setModoEdicion(nuevoModoEdicion);
        shiftPressCount.current = 0;
      } else {
        shiftTimer.current = setTimeout(() => {
          shiftPressCount.current = 0;
        }, 500);
      }
    }
  }, []);

  // Event listener para teclado
  useEffect(() => {
    window.addEventListener("keydown", handleKeyDown);
    return () => {
      window.removeEventListener("keydown", handleKeyDown);
      if (shiftTimer.current) {
        clearTimeout(shiftTimer.current);
      }
    };
  }, [handleKeyDown]);

  // üéØ SISTEMA DE SINCRONIZACI√ìN PERFECTA MEJORADO
  useEffect(() => {
    if (!textBlocks.length || modoEdicion) {
      console.log('‚è∏Ô∏è Avance pausado:', { textBlocksLength: textBlocks.length, modoEdicion });
      return;
    }

    if (advanceTimeout.current) {
      clearTimeout(advanceTimeout.current);
      console.log('‚è∞ Timeout anterior cancelado');
    }

    console.log(`üìç Bloque actual: ${currentIdx + 1}/${textBlocks.length} - "${currentDisplayText.substring(0, 50)}..."`);

    if (currentIdx >= textBlocks.length - 1) {
      // √öltimo bloque - MANTENER ABIERTO PARA LECTURA COMPLETA
      console.log('üèÅ √öLTIMO BLOQUE - Manteniendo abierto para lectura completa');
      console.log('üìñ Usuario puede leer tranquilamente sin presi√≥n de tiempo');
      return;
    }

    // üéµ C√ÅLCULO DE TIEMPO MEJORADO PARA SINCRONIZACI√ìN PERFECTA
    let readingTime;
    
    if (audioSyncDuration && audioStarted && textBlocks.length > 0) {
      // ‚úÖ MODO SINCRONIZADO CON AUDIO - SINCRONIZACI√ìN PERFECTA
      
      if (sincronizacionEspecifica && sincronizacionEspecifica.bloques) {
        // üéØ SINCRONIZACI√ìN ESPEC√çFICA - Usar tiempos exactos por bloque CON AJUSTE DE BUFFER
        console.log('üéØ Usando sincronizaci√≥n espec√≠fica con bloques definidos');
        
        const bloqueActual = sincronizacionEspecifica.bloques[currentIdx];
        if (bloqueActual) {
          // üîß AJUSTE LENTO: Los subt√≠tulos van m√°s lentos que el audio
          const bufferSeguridad = 500; // 500ms de buffer adicional
          const factorSeguridad = 1.15; // 15% m√°s tiempo que el audio (m√°s lento)
          readingTime = (bloqueActual.duracion * factorSeguridad) + bufferSeguridad;
          
          console.log(`üéØ ‚úÖ SINCRONIZACI√ìN LENTA:`);
          console.log(`   üìä Bloque ${currentIdx + 1}: ${bloqueActual.duracion}ms (original) √ó ${factorSeguridad} + ${bufferSeguridad}ms = ${readingTime}ms`);
          console.log(`   üìù Texto esperado: "${bloqueActual.texto.substring(0, 50)}..."`);
          console.log(`   üìù Texto actual: "${currentDisplayText.substring(0, 50)}..."`);
          console.log(`   ‚è±Ô∏è Tiempo total m√°s lento: ${(readingTime/1000).toFixed(2)}s`);
        } else {
          // Fallback mejorado si no hay bloque espec√≠fico
          const timePerBlock = audioSyncDuration / textBlocks.length;
          const currentBlockLength = currentDisplayText.length;
          const averageBlockLength = textBlocks.reduce((sum, block) => sum + block.length, 0) / textBlocks.length;
          const lengthRatio = currentBlockLength / averageBlockLength;
          
          // Aplicar factor de seguridad LENTO
          const factorFallback = 1.2; // 20% m√°s tiempo que el audio (m√°s lento)
          const bufferFallback = 400; // 400ms de buffer adicional
          readingTime = (timePerBlock * Math.max(1.0, Math.min(1.3, lengthRatio)) * factorFallback) + bufferFallback;
          console.log(`‚ö†Ô∏è Fallback LENTO - Bloque ${currentIdx + 1}: ${readingTime.toFixed(2)}ms`);
        }
      } else {
        // üìä SINCRONIZACI√ìN GEN√âRICA MEJORADA - M√°s conservadora
        console.log('üìä Usando sincronizaci√≥n gen√©rica mejorada');
        const timePerBlock = audioSyncDuration / textBlocks.length;
        const currentBlockLength = currentDisplayText.length;
        const averageBlockLength = textBlocks.reduce((sum, block) => sum + block.length, 0) / textBlocks.length;
        const lengthRatio = currentBlockLength / averageBlockLength;
        
        // üîß AJUSTE CR√çTICO LENTO: Los subt√≠tulos van m√°s lentos que el audio
        const factorSeguridad = 1.18; // 18% m√°s tiempo que el audio (m√°s lento)
        const bufferGenerico = 450; // 450ms de buffer adicional
        readingTime = (timePerBlock * Math.max(1.0, Math.min(1.3, lengthRatio)) * factorSeguridad) + bufferGenerico;
        
        console.log(`üéµ ‚úÖ SINCRONIZACI√ìN GEN√âRICA MEJORADA:`);
        console.log(`   üìä Audio total: ${(audioSyncDuration/1000).toFixed(2)}s`);
        console.log(`   üìä Tiempo base por bloque: ${(timePerBlock/1000).toFixed(2)}s`);
        console.log(`   üìä Factor de seguridad: ${factorSeguridad}x`);
        console.log(`   üìä Buffer adicional: ${bufferGenerico}ms`);
        console.log(`   üìä Longitud bloque actual: ${currentBlockLength} chars`);
        console.log(`   üìä Longitud promedio: ${averageBlockLength.toFixed(0)} chars`);
        console.log(`   üìä Ratio de ajuste: ${lengthRatio.toFixed(2)}`);
        console.log(`   ‚è±Ô∏è Tiempo final bloque ${currentIdx + 1}: ${(readingTime/1000).toFixed(2)}s`);
      }
      
    } else {
      // üö´ SIN AUDIO - Usar tiempo de lectura M√ÅS LENTO
      console.log('üö´ SIN SINCRONIZACI√ìN DE AUDIO - Usando tiempo de lectura m√°s lento');
      readingTime = calculateReadingTime(currentDisplayText) * 1.4; // 40% m√°s tiempo de lectura
    }

    // üéØ APLICAR AJUSTE MANUAL SI EXISTE
    const duracionFinal = manualSyncManager.calcularDuracionAjustada(readingTime, pregunta, currentIdx);
    
    // üöÄ PROGRAMAR AVANCE AL SIGUIENTE BLOQUE CON TIEMPO AJUSTADO (INCLUYENDO AJUSTES MANUALES)
    advanceTimeout.current = setTimeout(() => {
      console.log(`‚û°Ô∏è AVANZANDO CON SINCRONIZACI√ìN EQUILIBRADA: Bloque ${currentIdx + 1} ‚Üí ${currentIdx + 2}/${textBlocks.length}`);
      setCurrentIdx((idx) => {
        const nextIdx = idx + 1;
        console.log(`‚úÖ √çndice actualizado: ${idx} ‚Üí ${nextIdx}`);
        
        // üîß VERIFICACI√ìN: Si llegamos al final, marcar respuesta como completa
        if (nextIdx >= textBlocks.length) {
          console.log('üèÅ RESPUESTA COMPLETADA - Todos los bloques mostrados');
          if (onRespuestaCompleta) {
            setTimeout(() => {
              console.log('üìû Llamando onRespuestaCompleta');
              onRespuestaCompleta();
            }, 500);
          }
        }
        
        return nextIdx;
      });
    }, duracionFinal);

    return () => {
      if (advanceTimeout.current) {
        clearTimeout(advanceTimeout.current);
        advanceTimeout.current = null;
        console.log('üßπ Cleanup: timeout cancelado y limpiado');
      }
    };
  }, [
    currentIdx,
    textBlocks.length,
    onRespuestaCompleta,
    modoEdicion,
    currentDisplayText,
    audioSyncDuration,
    audioStarted,
    sincronizacionEspecifica,
  ]);

  useEffect(() => {
    if (onVisualizadorAbierto) onVisualizadorAbierto(mostrarVisualizador);
  }, [mostrarVisualizador, onVisualizadorAbierto]);

  // Guardar estilos globales en localStorage cuando cambien
  useEffect(() => {
    guardarEstilosGlobales(estilosGlobales);
  }, [estilosGlobales]);

  // üéØ ESTABLECER RESPUESTA EN PROCESO CUANDO HAY BLOQUES DE TEXTO
  useEffect(() => {
    if (textBlocks.length > 0 && currentIdx < textBlocks.length) {
      setRespuestaEnProceso(true);
      console.log('üéØ RESPUESTA EN PROCESO ACTIVADA - Sincronizaci√≥n manual disponible');
    } else {
      setRespuestaEnProceso(false);
      console.log('üéØ RESPUESTA COMPLETADA - Sincronizaci√≥n manual desactivada');
    }
  }, [textBlocks.length, currentIdx]);

  // üéØ MANEJO DE TECLAS G y H PARA SINCRONIZACI√ìN MANUAL MEJORADO
  useEffect(() => {
    const handleKeyPress = (event) => {
      // Solo funcionar si no estamos en modo edici√≥n y hay bloques de texto
      if (modoEdicion || textBlocks.length === 0) {
        console.log(`üö´ TECLA IGNORADA: ${event.key} - Modo edici√≥n: ${modoEdicion}, Bloques: ${textBlocks.length}`);
        return;
      }
      
      console.log(`üéØ TECLA DETECTADA: ${event.key}, Modo edici√≥n: ${modoEdicion}, Bloque actual: ${currentIdx + 1}/${textBlocks.length}`);

      const key = event.key.toLowerCase();
      
      // üéØ NAVEGACI√ìN ENTRE BLOQUES: TAB + FLECHAS IZQUIERDA/DERECHA
      if (event.key === 'Tab') {
        event.preventDefault();
        if (event.shiftKey) {
          // Tab + Shift: Ir al bloque anterior
          const nuevoIdx = Math.max(0, currentIdx - 1);
          if (nuevoIdx !== currentIdx) {
            setCurrentIdx(nuevoIdx);
            console.log(`‚¨ÖÔ∏è TAB+SHIFT: Navegando al bloque anterior ${nuevoIdx + 1}/${textBlocks.length}`);
            console.log(`üìù Bloque actual: "${textBlocks[nuevoIdx]?.substring(0, 50)}..."`);
          }
        } else {
          // Tab solo: Ir al bloque siguiente
          const nuevoIdx = Math.min(textBlocks.length - 1, currentIdx + 1);
          if (nuevoIdx !== currentIdx) {
            setCurrentIdx(nuevoIdx);
            console.log(`‚û°Ô∏è TAB: Navegando al bloque siguiente ${nuevoIdx + 1}/${textBlocks.length}`);
            console.log(`üìù Bloque actual: "${textBlocks[nuevoIdx]?.substring(0, 50)}..."`);
          }
        }
        return;
      }

      // üéØ NAVEGACI√ìN CON TAB + FLECHAS (alternativa)
      if ((event.key === 'ArrowLeft' || event.key === 'ArrowRight') && event.ctrlKey) {
        event.preventDefault();
        if (event.key === 'ArrowLeft') {
          // Ctrl + Flecha Izquierda: Bloque anterior
          const nuevoIdx = Math.max(0, currentIdx - 1);
          if (nuevoIdx !== currentIdx) {
            setCurrentIdx(nuevoIdx);
            console.log(`‚¨ÖÔ∏è CTRL+FLECHA IZQUIERDA: Bloque ${nuevoIdx + 1}/${textBlocks.length}`);
          }
        } else {
          // Ctrl + Flecha Derecha: Bloque siguiente
          const nuevoIdx = Math.min(textBlocks.length - 1, currentIdx + 1);
          if (nuevoIdx !== currentIdx) {
            setCurrentIdx(nuevoIdx);
            console.log(`‚û°Ô∏è CTRL+FLECHA DERECHA: Bloque ${nuevoIdx + 1}/${textBlocks.length}`);
          }
        }
        return;
      }
      
      // üÜï CTRL + G: Decrementar duraci√≥n de TODA la respuesta
      if (event.ctrlKey && key === 'g') {
        event.preventDefault();
        const nuevoAjuste = manualSyncManager.decrementarDuracionGlobal(pregunta, textBlocks.length);
        setAjusteManualActual(nuevoAjuste);
        setModoSincronizacionManual(true);
        setMostrarIndicadorAjuste(true);
        setEsAjusteGlobal(true);
        
        // Mostrar indicador m√°s tiempo para ajustes globales
        setTimeout(() => {
          setMostrarIndicadorAjuste(false);
          setEsAjusteGlobal(false);
        }, 3000);
        
        console.log(`üîß CTRL+G - Decrementar duraci√≥n GLOBAL: ${nuevoAjuste}ms por bloque`);
        
        // Aplicar ajuste inmediato si estamos reproduciendo
        aplicarAjusteInmediato();
        
      // üÜï CTRL + H: Incrementar duraci√≥n de TODA la respuesta  
      } else if (event.ctrlKey && key === 'h') {
        event.preventDefault();
        const nuevoAjuste = manualSyncManager.incrementarDuracionGlobal(pregunta, textBlocks.length);
        setAjusteManualActual(nuevoAjuste);
        setModoSincronizacionManual(true);
        setMostrarIndicadorAjuste(true);
        setEsAjusteGlobal(true);
        
        // Mostrar indicador m√°s tiempo para ajustes globales
        setTimeout(() => {
          setMostrarIndicadorAjuste(false);
          setEsAjusteGlobal(false);
        }, 3000);
        
        console.log(`üîß CTRL+H - Incrementar duraci√≥n GLOBAL: ${nuevoAjuste}ms por bloque`);
        
        // Aplicar ajuste inmediato si estamos reproduciendo
        aplicarAjusteInmediato();
        
      } else if (key === 'g' && currentIdx < textBlocks.length) {
        // Tecla G: Decrementar duraci√≥n del bloque actual
        event.preventDefault();
        const nuevoAjuste = manualSyncManager.decrementarDuracion(pregunta, currentIdx);
        setAjusteManualActual(nuevoAjuste);
        setModoSincronizacionManual(true);
        setMostrarIndicadorAjuste(true);
        
        // Ocultar indicador despu√©s de 2 segundos
        setTimeout(() => setMostrarIndicadorAjuste(false), 2000);
        
        console.log(`üîß TECLA G - Decrementar duraci√≥n bloque ${currentIdx + 1}: ${nuevoAjuste}ms`);
        console.log(`üíæ Cambio guardado permanentemente en el proyecto`);
        
        // Aplicar ajuste inmediato si estamos reproduciendo
        aplicarAjusteInmediato();
        
      } else if (key === 'h' && currentIdx < textBlocks.length) {
        // Tecla H: Incrementar duraci√≥n del bloque actual
        event.preventDefault();
        const nuevoAjuste = manualSyncManager.incrementarDuracion(pregunta, currentIdx);
        setAjusteManualActual(nuevoAjuste);
        setModoSincronizacionManual(true);
        setMostrarIndicadorAjuste(true);
        
        // Ocultar indicador despu√©s de 2 segundos
        setTimeout(() => setMostrarIndicadorAjuste(false), 2000);
        
        console.log(`üîß TECLA H - Incrementar duraci√≥n bloque ${currentIdx + 1}: ${nuevoAjuste}ms`);
        console.log(`üíæ Cambio guardado permanentemente en el proyecto`);
        
        // Aplicar ajuste inmediato si estamos reproduciendo
        aplicarAjusteInmediato();
      }
    };

    // üÜï Funci√≥n para aplicar ajuste inmediato durante la reproducci√≥n
    const aplicarAjusteInmediato = () => {
      if (advanceTimeout.current && currentIdx < textBlocks.length) {
        clearTimeout(advanceTimeout.current);
        
        // Calcular duraci√≥n base del bloque actual
        let readingTime = calculateReadingTime(currentDisplayText) * 1.4;
        if (audioSyncDuration) {
          const timePerBlock = audioSyncDuration / textBlocks.length;
          readingTime = timePerBlock * 1.18 + 450;
        }
        
        // Aplicar el ajuste manual espec√≠fico para este bloque
        const duracionAjustada = manualSyncManager.calcularDuracionAjustada(readingTime, pregunta, currentIdx);
        
        console.log(`‚è±Ô∏è DURACI√ìN ACTUALIZADA INMEDIATAMENTE: ${(duracionAjustada/1000).toFixed(1)}s para bloque ${currentIdx + 1}`);
        
        // Programar nuevo timeout con la duraci√≥n ajustada
        advanceTimeout.current = setTimeout(() => {
          setCurrentIdx((idx) => {
            const nextIdx = idx + 1;
            if (nextIdx >= textBlocks.length && onRespuestaCompleta) {
              setTimeout(() => onRespuestaCompleta(), 500);
            }
            return nextIdx;
          });
        }, duracionAjustada);
      }
    };

    // Agregar event listener
    window.addEventListener('keydown', handleKeyPress);

    // Cleanup
    return () => {
      window.removeEventListener('keydown', handleKeyPress);
    };
  }, [modoEdicion, currentIdx, pregunta, textBlocks.length, currentDisplayText, audioSyncDuration, onRespuestaCompleta, advanceTimeout]);

  // Funci√≥n para guardar texto editado del bloque actual
  const handleTextChange = (newText) => {
    setTextosEditados((prev) => ({
      ...prev,
      [currentIdx]: newText,
    }));
  };

  // Funci√≥n para guardar cambios permanentemente
  const guardarCambiosPermanentes = async () => {
    if (Object.keys(textosEditados).length === 0) return;

    try {
      console.log('üíæ Guardando cambios permanentes...', {
        pregunta: pregunta.pregunta,
        textosEditados
      });

      // Crear nueva respuesta con textos editados
      const nuevaRespuesta = textBlocks.map((bloque, index) => {
        return textosEditados[index] || bloque;
      }).join(' ');

      // Enviar al servidor para guardar en archivos
      const response = await fetch('http://localhost:5005/api/guardar-edicion', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          pregunta: pregunta.pregunta,
          nuevaRespuesta,
          textosEditados,
          categoria: obtenerCategoriaPregunta(pregunta)?.categoria,
          clave: obtenerCategoriaPregunta(pregunta)?.clave
        }),
      });

      if (response.ok) {
        const result = await response.json();
        console.log('‚úÖ Cambios guardados permanentemente:', result);
        
        // Actualizar la respuesta local
        pregunta.respuesta = nuevaRespuesta;
        
        // Mostrar notificaci√≥n visual
        alert('üíæ Cambios guardados permanentemente en los archivos del proyecto');
        
        // Limpiar textos editados
        setTextosEditados({});
      } else {
        console.error('‚ùå Error al guardar cambios');
        alert('‚ùå Error al guardar cambios. Verifica que el servidor de edici√≥n est√© ejecut√°ndose.');
      }
    } catch (error) {
      console.error('‚ùå Error al guardar cambios:', error);
    }
  };

  return (
    <>
      {/* üéØ ESTILOS CSS PARA ANIMACIONES DE SINCRONIZACI√ìN MANUAL */}
      <style>
        {`
          @keyframes slideInRight {
            from {
              transform: translateX(100%);
              opacity: 0;
            }
            to {
              transform: translateX(0);
              opacity: 1;
            }
          }
          
          @keyframes pulse {
            0%, 100% {
              opacity: 1;
            }
            50% {
              opacity: 0.7;
            }
          }
          
          .manual-sync-indicator {
            animation: slideInRight 0.3s ease-out;
          }
          
          .manual-sync-controls {
            transition: all 0.3s ease;
          }
          
          .manual-sync-controls:hover {
            background: rgba(0, 0, 0, 0.9) !important;
            transform: scale(1.02);
          }
        `}
      </style>

      {/* Bot√≥n de volver */}
      <button
        onClick={() => {
          console.log('üîÑ BOT√ìN VOLVER - AudioManagerFinal');
          
          // üîá DETENER TODO CON SISTEMA FINAL
          audioManagerFinal.stopAll();
          
          // Cancelar timeouts
          if (advanceTimeout.current) {
            clearTimeout(advanceTimeout.current);
            advanceTimeout.current = null;
          }
          
          // Resetear estados
          setAudioSyncDuration(null);
          setAudioStarted(false);
          setRespuestaEnProceso(false);
          setCurrentIdx(0);
          setLastProcessedQuestion('');
          audioProcessingRef.current = false; // Resetear bandera de procesamiento
          
          console.log('üîá ‚úÖ Todo detenido con AudioManagerFinal');
          onVolver();
        }}
        title="Volver"
        style={{
          position: "fixed",
          top: "32px",
          left: "32px",
          zIndex: 100,
          pointerEvents: "auto",
          width: "54px",
          height: "54px",
          borderRadius: "50%",
          background: "#ffffff",
          border: "2px solid #0369a1",
          boxShadow: "rgba(2, 132, 199, 0.15) 0px 2px 8px",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          cursor: "pointer",
          transition: "all 0.2s ease-out",
          padding: 0,
          pointerEvents: "auto", // IMPORTANTE: Hacer el bot√≥n interactivo
        }}
        onMouseEnter={(e) => {
          e.target.style.transform = "scale(1.05)";
          e.target.style.boxShadow = "rgba(2, 132, 199, 0.25) 0px 4px 12px";
        }}
        onMouseLeave={(e) => {
          e.target.style.transform = "scale(1)";
          e.target.style.boxShadow = "rgba(2, 132, 199, 0.15) 0px 2px 8px";
        }}
      >
        <span
          style={{
            fontSize: "28px",
            display: "inline-block",
            transform: "rotate(180deg)",
            transition: "transform 0.3s ease-out",
            transformOrigin: "center center",
            lineHeight: 1,
            color: "#0369a1",
          }}
        >
          ‚ûú
        </span>
      </button>

      {/* Indicador de modo edici√≥n */}
      {modoEdicion && (
        <div
          style={{
            position: "fixed",
            top: "32px",
            right: "32px",
            zIndex: 100,
            background: "rgba(255, 165, 0, 0.9)",
            color: "white",
            padding: "8px 16px",
            borderRadius: "20px",
            fontSize: "0.9rem",
            fontWeight: "600",
            boxShadow: "0 4px 12px rgba(255, 165, 0, 0.3)",
            animation: "pulse 2s infinite",
          }}
        >
          üé® EDITANDO BLOQUE {currentIdx + 1}/{textBlocks.length}
        </div>
      )}

      {/* üéØ INDICADOR DE SINCRONIZACI√ìN MANUAL */}
      {mostrarIndicadorAjuste && (
        <div
          style={{
            position: "fixed",
            top: "100px",
            right: "32px",
            zIndex: 100,
            background: ajusteManualActual >= 0 ? "rgba(34, 197, 94, 0.95)" : "rgba(239, 68, 68, 0.95)",
            color: "white",
            padding: "16px 24px",
            borderRadius: "20px",
            fontSize: "1rem",
            fontWeight: "600",
            boxShadow: "0 8px 25px rgba(0, 0, 0, 0.4)",
            animation: "slideInRight 0.3s ease-out",
            display: "flex",
            flexDirection: "column",
            alignItems: "center",
            gap: "8px",
            backdropFilter: "blur(10px)",
            border: "2px solid rgba(255, 255, 255, 0.2)",
          }}
        >
          <div style={{ display: "flex", alignItems: "center", gap: "10px" }}>
            <span style={{ fontSize: "1.4rem" }}>
              {ajusteManualActual >= 0 ? "‚¨ÜÔ∏è" : "‚¨áÔ∏è"}
            </span>
            <div style={{ textAlign: "center" }}>
              <div style={{ fontSize: "0.75rem", opacity: 0.9, marginBottom: "2px" }}>
                BLOQUE {currentIdx + 1} - AJUSTE APLICADO
              </div>
              <div style={{ fontSize: "1.2rem", fontWeight: "700" }}>
                {ajusteManualActual >= 0 ? "+" : ""}{(ajusteManualActual / 1000).toFixed(1)}s
              </div>
              <div style={{ fontSize: "0.65rem", opacity: 0.8, marginTop: "2px", fontStyle: "italic" }}>
                ‚úÖ Guardado para este bloque
              </div>
            </div>
          </div>
          
          {/* Controles disponibles */}
          <div style={{ 
            fontSize: "0.7rem", 
            opacity: 0.8, 
            textAlign: "center",
            borderTop: "1px solid rgba(255, 255, 255, 0.3)",
            paddingTop: "6px",
            marginTop: "2px"
          }}>
            <div style={{ display: "flex", gap: "12px", justifyContent: "center" }}>
              <span style={{ color: "#ffcccb" }}>G: -0.5s</span>
              <span style={{ color: "#c8e6c9" }}>H: +0.5s</span>
            </div>
          </div>
        </div>
      )}


      {/* Contenedor principal de subt√≠tulos */}
      <div
        style={{
          position: "fixed",
          bottom: modoEdicion ? estilosActuales.bottom : "1rem",
          left: "50%",
          transform: "translateX(-50%)",
          zIndex: 10,
          width: "95%",
          maxWidth: "1200px",
          display: "flex",
          flexDirection: "column",
          alignItems: "center",
          padding: modoEdicion ? "2rem" : "0",
          background: modoEdicion
            ? "linear-gradient(135deg, rgba(0, 0, 0, 0.85), rgba(30, 30, 30, 0.8))"
            : "none",
          borderRadius: modoEdicion ? "20px 20px 0 0" : "0",
          border: modoEdicion ? "2px solid rgba(255, 165, 0, 0.3)" : "none",
          transition: "all 0.3s ease",
          pointerEvents: "auto", // IMPORTANTE: Hacer el contenedor interactivo
        }}
      >
        {/* Modo edici√≥n */}
        {modoEdicion ? (
          <div
            style={{
              display: "flex",
              flexDirection: "column",
              alignItems: "center",
              gap: "1.5rem",
              width: "100%",
              maxWidth: "1000px",
            }}
          >
            {/* Panel de controles */}
            <div
              style={{
                position: "relative",
                display: "flex",
                gap: "1.5rem",
                flexWrap: "wrap",
                justifyContent: "center",
                background: "rgba(255, 255, 255, 0.1)",
                padding: "1.5rem",
                borderRadius: "16px",
                backdropFilter: "blur(10px)",
                border: "1px solid rgba(255, 255, 255, 0.2)",
                width: "100%",
              }}
            >
              {/* Bot√≥n de Toggle Edici√≥n Global/Individual */}
              <button
                onClick={() => setEdicionGlobal(!edicionGlobal)}
                style={{
                  position: "absolute",
                  top: "-10px",
                  left: "15px",
                  background: edicionGlobal ? "#10b981" : "#3b82f6",
                  color: "white",
                  border: "none",
                  borderRadius: "20px",
                  padding: "4px 12px",
                  cursor: "pointer",
                  fontSize: "0.75rem",
                  fontWeight: "600",
                  boxShadow: "0 2px 8px rgba(0, 0, 0, 0.3)",
                  transition: "all 0.2s ease",
                }}
                title={
                  edicionGlobal
                    ? "Cambiar a edici√≥n individual"
                    : "Cambiar a edici√≥n global"
                }
              >
                {edicionGlobal ? "üåç GLOBAL" : "üìù INDIVIDUAL"}
              </button>

              {/* Bot√≥n de Reset */}
              <button
                onClick={() => {
                  if (edicionGlobal) {
                    const valoresSubtitulos = {
                      ...estilosDefecto,
                      bottom: "1rem",
                      marginBottom: "0.5rem",
                    };
                    setEstilosGlobales(valoresSubtitulos);
                    guardarEstilosGlobales(valoresSubtitulos);
                  } else {
                    const valoresSubtitulos = {
                      ...estilosDefecto,
                      bottom: "1rem",
                      marginBottom: "0.5rem",
                    };
                    setEstilosIndividuales((prev) => ({
                      ...prev,
                      [currentIdx]: valoresSubtitulos,
                    }));
                  }
                  setTextosEditados((prev) => ({
                    ...prev,
                    [currentIdx]: currentBlock,
                  }));
                }}
                style={{
                  position: "absolute",
                  top: "-10px",
                  right: "15px",
                  background: "#ff6b35",
                  color: "white",
                  border: "none",
                  borderRadius: "50%",
                  width: "32px",
                  height: "32px",
                  cursor: "pointer",
                  fontSize: "0.9rem",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  boxShadow: "0 2px 6px rgba(255, 107, 53, 0.4)",
                  transition: "all 0.2s ease",
                }}
                title="Resetear valores por defecto"
              >
                ‚Ü∫
              </button>

              {/* Controls */}
              {[
                {
                  label: "Ancho",
                  prop: "width",
                  min: 400,
                  max: 1200,
                  step: 50,
                  unit: "px",
                },
                {
                  label: "Tama√±o",
                  prop: "fontSize",
                  min: 1,
                  max: 3,
                  step: 0.1,
                  unit: "rem",
                },
                {
                  label: "Interlineado",
                  prop: "lineHeight",
                  min: 1,
                  max: 2.5,
                  step: 0.1,
                  unit: "",
                },
                {
                  label: "üìç Altura desde abajo",
                  prop: "bottom",
                  min: 0,
                  max: 20,
                  step: 0.5,
                  unit: "rem",
                },
                {
                  label: "üìè Espaciado inferior",
                  prop: "marginBottom",
                  min: 0,
                  max: 5,
                  step: 0.25,
                  unit: "rem",
                },
              ].map(({ label, prop, min, max, step, unit }) => (
                <label
                  key={prop}
                  style={{
                    color: "white",
                    fontSize: "0.9rem",
                    display: "flex",
                    flexDirection: "column",
                    alignItems: "center",
                    gap: "0.5rem",
                    minWidth: "120px",
                  }}
                >
                  <span style={{ fontWeight: "600" }}>{label}</span>
                  <input
                    type="range"
                    min={min}
                    max={max}
                    step={step}
                    value={parseFloat(estilosActuales[prop])}
                    onChange={(e) => {
                      const newValue = e.target.value + (unit || "");
                      if (edicionGlobal) {
                        setEstilosGlobales((prev) => ({
                          ...prev,
                          [prop]: newValue,
                        }));
                      } else {
                        setEstilosIndividuales((prev) => ({
                          ...prev,
                          [currentIdx]: {
                            ...(prev[currentIdx] || estilosGlobales),
                            [prop]: newValue,
                          },
                        }));
                      }
                    }}
                    style={{
                      accentColor: "#ff6b35",
                      width: "100px",
                    }}
                  />
                  <span
                    style={{
                      color: "#ff6b35",
                      fontWeight: "600",
                      fontSize: "0.8rem",
                    }}
                  >
                    {estilosActuales[prop]}
                  </span>
                </label>
              ))}
            </div>

            {/* Informaci√≥n del modo de edici√≥n */}
            <div
              style={{
                color: "rgba(255, 255, 255, 0.9)",
                fontSize: "0.85rem",
                textAlign: "center",
                marginBottom: "0.8rem",
                padding: "0.4rem 0.8rem",
                backgroundColor: "rgba(255, 255, 255, 0.1)",
                borderRadius: "8px",
                border: "1px solid rgba(255, 255, 255, 0.2)",
              }}
            >
              {edicionGlobal ? (
                <div>
                  <div>
                    üåç <strong>MODO GLOBAL:</strong> Los cambios se aplican a
                    todos los bloques de todas las respuestas
                  </div>
                  <div
                    style={{
                      marginTop: "0.3rem",
                      fontSize: "0.75rem",
                      opacity: 0.8,
                    }}
                  >
                    üìç Posicionado como subt√≠tulos reales en la parte inferior
                  </div>
                </div>
              ) : (
                <div>
                  <div>
                    üìù <strong>MODO INDIVIDUAL:</strong> Los cambios solo
                    afectan al bloque actual
                  </div>
                  <div
                    style={{
                      marginTop: "0.3rem",
                      fontSize: "0.75rem",
                      opacity: 0.8,
                    }}
                  >
                    üéØ Editando √∫nicamente este bloque
                  </div>
                </div>
              )}
            </div>

            {/* Vista previa del texto editado */}
            <div
              style={{
                fontSize: estilosActuales.fontSize,
                lineHeight: estilosActuales.lineHeight,
                color: "white",
                textAlign: "center",
                width: estilosActuales.width,
                minHeight: "3rem",
                padding: "1rem 1.5rem",
                backgroundColor: "rgba(0, 0, 0, 0.7)",
                borderRadius: "16px",
                border: "2px solid rgba(255, 107, 53, 0.5)",
                backdropFilter: "blur(8px)",
                textShadow: "none",
                fontWeight: "600",
                letterSpacing: "0.5px",
                wordWrap: "break-word",
                transition: "all 0.2s ease",
              }}
            >
              {currentDisplayText}
            </div>

            {/* Editor de texto */}
            <textarea
              value={currentDisplayText}
              onChange={(e) => handleTextChange(e.target.value)}
              style={{
                width: estilosActuales.width,
                height: "120px",
                fontSize: "1rem",
                lineHeight: "1.4",
                color: "white",
                backgroundColor: "rgba(0, 0, 0, 0.7)",
                border: "2px solid rgba(255, 107, 53, 0.5)",
                borderRadius: "12px",
                padding: "1rem",
                textAlign: "left",
                resize: "vertical",
                outline: "none",
                transition: "all 0.2s ease",
                boxShadow: "0 4px 12px rgba(0, 0, 0, 0.3)",
                backdropFilter: "blur(5px)",
              }}
              placeholder="Edita el texto del bloque actual aqu√≠..."
            />

            {/* Instrucciones */}
            <div
              style={{
                color: "rgba(255, 255, 255, 0.8)",
                fontSize: "0.85rem",
                textAlign: "center",
                display: "flex",
                gap: "2rem",
                justifyContent: "center",
                flexWrap: "wrap",
                marginTop: "0.5rem",
              }}
            >
              <span>üìù Shift + Shift para continuar</span>
              <span>‚Ü∫ Reset {edicionGlobal ? "global" : "bloque"}</span>
              <span>üåç/üìù Cambiar modo edici√≥n</span>
              <span>
                üé¨ Bloque {currentIdx + 1} de {textBlocks.length}
              </span>
              <span>üìç Posici√≥n de subt√≠tulos optimizada</span>
              <span style={{ color: "#22c55e" }}>üéµ G/H: Sincronizaci√≥n manual</span>
            </div>
            
            {/* üéØ INFORMACI√ìN ADICIONAL SOBRE SINCRONIZACI√ìN MANUAL */}
            <div
              style={{
                color: "rgba(255, 255, 255, 0.7)",
                fontSize: "0.75rem",
                textAlign: "center",
                marginTop: "0.8rem",
                padding: "0.8rem",
                backgroundColor: "rgba(34, 197, 94, 0.1)",
                borderRadius: "12px",
                border: "1px solid rgba(34, 197, 94, 0.3)",
              }}
            >
              <div style={{ marginBottom: "0.4rem", fontWeight: "600", color: "#22c55e" }}>
                üéµ SINCRONIZACI√ìN MANUAL DISPONIBLE
              </div>
              <div style={{ display: "flex", gap: "1.5rem", justifyContent: "center", flexWrap: "wrap" }}>
                <span>üî¥ <strong>G:</strong> Reducir duraci√≥n (-0.5s)</span>
                <span>üü¢ <strong>H:</strong> Aumentar duraci√≥n (+0.5s)</span>
                <span>üíæ Los ajustes se guardan autom√°ticamente</span>
              </div>
              {manualSyncManager.obtenerEstadisticasAjustes(pregunta).bloquesAjustados > 0 && (
                <div style={{ marginTop: "0.4rem", color: "#fbbf24" }}>
                  üìä {manualSyncManager.obtenerEstadisticasAjustes(pregunta).bloquesAjustados} bloques con ajustes manuales
                </div>
              )}
            </div>
          </div>
        ) : (
          /* Subt√≠tulos reales en la parte inferior - ALTURA CONSISTENTE */
          <div
            style={{
              fontSize: estilosActuales.fontSize,
              lineHeight: estilosActuales.lineHeight,
              color: "white",
              textAlign: "center",
              width: estilosActuales.width,
              minHeight: "2rem", // Altura m√≠nima consistente
              maxHeight: "6rem", // Altura m√°xima para evitar variaciones
              padding: "0.5rem 1rem",
              position: "relative",
              background: "none",
              border: "none",
              textShadow: "none",
              fontWeight: "600",
              letterSpacing: "0.6px",
              wordWrap: "break-word",
              transition: "all 0.2s ease",
              maxWidth: "95vw",
              margin: "0 auto",
              fontFamily:
                "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif",
              WebkitFontSmoothing: "antialiased",
              MozOsxFontSmoothing: "grayscale",
              textRendering: "optimizeLegibility",
              filter: "contrast(1.05) brightness(1.02)",
              fontOpticalSizing: "auto",
              marginBottom: estilosActuales.marginBottom,
              // Asegurar altura consistente usando flexbox
              display: "flex",
              alignItems: "center",
              justifyContent: "center",
            }}
          >
            {currentDisplayText}
          </div>
        )}

        {/* Visualizador multimedia */}
        {mostrarVisualizador && (
          <div style={{ marginTop: "1rem" }}>
            <VisualizadorMultimedia
              pregunta={pregunta.pregunta}
              archivo={pregunta.archivo}
              tipo={pregunta.tipo}
              info={pregunta.info}
              onClose={() => {
                setMostrarVisualizador(false);
                if (onVisualizadorAbierto) onVisualizadorAbierto(false);
              }}
            />
          </div>
        )}
      </div>
    </>
  );
}
