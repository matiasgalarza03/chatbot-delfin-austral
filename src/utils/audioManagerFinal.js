// üéµ SISTEMA DE AUDIO FINAL - SOLUCI√ìN DEFINITIVA
// Este archivo reemplaza TODOS los sistemas de audio anteriores

class AudioManagerFinal {
  constructor() {
    // üîí SINGLETON: Asegurar que solo hay una instancia
    if (window.audioManagerFinalInstance) {
      console.log('‚ö†Ô∏è AudioManagerFinal ya existe, usando instancia existente');
      return window.audioManagerFinalInstance;
    }
    
    this.currentAudio = null;
    this.isPlaying = false;
    this.audioQueue = [];
    this.globalAudioRefs = [
      'window.malvinCurrentAudio',
      'window.currentPlayingAudio', 
      'window.malvinAudio'
    ];
    
    // Marcar como instancia global
    window.audioManagerFinalInstance = this;
    console.log('üîí AudioManagerFinal: Instancia √∫nica creada');
  }

  // üîá DETENER TODO - Funci√≥n ULTRA AGRESIVA
  stopAll() {
    console.log('üîá AudioManagerFinal: DETENIENDO TODO AGRESIVAMENTE...');
    
    // 1. Detener audio actual
    if (this.currentAudio) {
      try {
        this.currentAudio.pause();
        this.currentAudio.currentTime = 0;
        this.currentAudio.src = '';
        this.currentAudio.load(); // Forzar recarga para limpiar buffer
        this.currentAudio.remove?.();
        this.currentAudio = null;
        console.log('‚úÖ Audio actual detenido y limpiado');
      } catch (e) {
        console.log('‚ö†Ô∏è Error deteniendo audio actual:', e);
      }
    }

    // 2. Limpiar TODAS las referencias globales posibles
    try {
      const globalRefs = [
        'malvinCurrentAudio',
        'currentPlayingAudio', 
        'malvinAudio',
        'audioElement',
        'currentAudio',
        'playingAudio'
      ];
      
      globalRefs.forEach(ref => {
        if (window[ref]) {
          try {
            if (window[ref].pause) window[ref].pause();
            if (window[ref].load) window[ref].load();
            window[ref] = null;
            console.log(`‚úÖ Referencia global ${ref} limpiada`);
          } catch (e) {
            console.log(`‚ö†Ô∏è Error limpiando ${ref}:`, e);
          }
        }
      });
    } catch (e) {
      console.log('‚ö†Ô∏è Error limpiando referencias globales:', e);
    }

    // 3. DETENER TODOS los elementos audio del DOM de forma agresiva
    const allAudios = document.querySelectorAll('audio');
    console.log(`üîç Encontrados ${allAudios.length} elementos audio en DOM`);
    
    allAudios.forEach((audio, index) => {
      try {
        // Detener reproducci√≥n
        audio.pause();
        audio.currentTime = 0;
        
        // Limpiar fuentes
        audio.src = '';
        audio.srcObject = null;
        
        // Forzar recarga para limpiar buffers
        audio.load();
        
        // Eliminar eventos
        audio.onloadedmetadata = null;
        audio.onended = null;
        audio.onerror = null;
        audio.onplay = null;
        audio.onpause = null;
        
        // Remover del DOM
        if (audio.parentNode) {
          audio.parentNode.removeChild(audio);
        }
        
        console.log(`‚úÖ Audio DOM ${index + 1} completamente eliminado`);
      } catch (e) {
        console.log(`‚ö†Ô∏è Error eliminando audio ${index + 1}:`, e);
      }
    });

    // 4. Detener Web Audio API si est√° en uso
    try {
      if (window.AudioContext || window.webkitAudioContext) {
        const contexts = [];
        // Buscar contextos de audio activos
        if (window.audioContext) contexts.push(window.audioContext);
        if (window.webkitAudioContext) contexts.push(window.webkitAudioContext);
        
        contexts.forEach(ctx => {
          if (ctx && ctx.state !== 'closed') {
            ctx.suspend().then(() => {
              console.log('‚úÖ Contexto de audio suspendido');
            }).catch(e => {
              console.log('‚ö†Ô∏è Error suspendiendo contexto:', e);
            });
          }
        });
      }
    } catch (e) {
      console.log('‚ö†Ô∏è Error con Web Audio API:', e);
    }

    // 5. Detener Speech Synthesis si est√° activo
    try {
      if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
        console.log('‚úÖ Speech Synthesis cancelado');
      }
    } catch (e) {
      console.log('‚ö†Ô∏è Error cancelando Speech Synthesis:', e);
    }

    // 6. Resetear estado interno
    this.isPlaying = false;
    this.audioQueue = [];
    
    console.log('üîá ‚úÖ AudioManagerFinal: TODO DETENIDO AGRESIVAMENTE');
  }

  // üéµ MAPEO CORRECTO DE PREGUNTAS A AUDIOS
  getAudioPath(pregunta) {
    if (!pregunta?.pregunta) return null;
    
    const q = pregunta.pregunta.toLowerCase().trim();
    console.log('üîç Mapeando pregunta:', q);
    
    // === DELF√çN AUSTRAL ===
    if (q === '¬°hola!') {
      return '/audios/respuestas_predefinidas/delfin_austral/01_presentacion.mp3';
    }
    if (q === '¬øqu√© eres?') {
      return '/audios/respuestas_predefinidas/delfin_austral/02_naturaleza.mp3';
    }
    if (q === '¬øpara qu√© fuiste creado?') {
      return '/audios/respuestas_predefinidas/delfin_austral/03_proposito.mp3';
    }
    if (q === '¬øqu√© puedes hacer?') {
      return '/audios/respuestas_predefinidas/delfin_austral/04_funcionalidades.mp3';
    }
    
    // === ESCUELA SECUNDARIA ===
    if (q === '¬øcu√°ndo se fund√≥ la escuela y d√≥nde se encuentra ubicada?') {
      return '/audios/respuestas_predefinidas/escuela_secundaria/01_historia_ubicacion.mp3';
    }
    if (q.includes('por qu√© se llama "malvinas argentinas"') || 
        (q.includes('malvinas argentinas') && q.includes('proyectos'))) {
      return '/audios/respuestas_predefinidas/escuela_secundaria/02_nombre_proyectos.mp3';
    }
    if (q.includes('qui√©nes dise√±aron el logo') && q.includes('escuela')) {
      return '/audios/respuestas_predefinidas/escuela_secundaria/03_logo_bandera.mp3';
    }
    if (q.includes('qui√©nes forman el equipo directivo') || 
        q.includes('equipo directivo')) {
      return '/audios/respuestas_predefinidas/escuela_secundaria/04_equipo_directivo.mp3';
    }
    if (q.includes('cuenta con espacios dedicados') || 
        q.includes('espacios educativos')) {
      return '/audios/respuestas_predefinidas/escuela_secundaria/05_espacios_educativos.mp3';
    }
    
    // === MUSEO ESCOLAR ===
    if (q === '¬øqu√© es el museo escolar?' || 
        (q.includes('museo escolar') && q.includes('qu√© es'))) {
      return '/audios/respuestas_predefinidas/museo_escolar/01_definicion.mp3';
    }
    if (q.includes('cu√°les son los objetivos del museo') || 
        (q.includes('museo') && q.includes('objetivos'))) {
      return '/audios/respuestas_predefinidas/museo_escolar/02_objetivos.mp3';
    }
    if (q.includes('qu√© actividades se realizan') || 
        (q.includes('museo') && q.includes('actividades'))) {
      return '/audios/respuestas_predefinidas/museo_escolar/03_actividades.mp3';
    }
    if (q.includes('qu√© recursos est√°n disponibles') || 
        (q.includes('museo') && q.includes('recursos'))) {
      return '/audios/respuestas_predefinidas/museo_escolar/04_recursos.mp3';
    }
    
    // === MALVINAS - CONTEXTO GEOGR√ÅFICO HIST√ìRICO ===
    // ‚ö†Ô∏è MAPEO EXACTO PRIORITARIO - DEBE IR ANTES DE CUALQUIER MAPEO ALTERNATIVO
    
    // Mapeo exacto por preguntas espec√≠ficas (EXACTAMENTE como est√°n en Respuestas.json)
    if (q === '¬øqui√©n descubri√≥ las islas malvinas?') {
      console.log('üéµ MALVINAS: Reproduciendo descubrimiento');
      return '/audios/respuestas_predefinidas/malvinas/contexto_geografico/01_descubrimiento.mp3';
    }
    if (q === '¬øcu√°l es la historia territorial de las malvinas antes de 1982?') {
      console.log('üéµ MALVINAS: Reproduciendo historia territorial');
      return '/audios/respuestas_predefinidas/malvinas/contexto_geografico/02_historia.mp3';
    }
    if (q === '¬øcual es la bandera actual de las islas malvinas?') {
      console.log('üéµ MALVINAS: Reproduciendo bandera');
      return '/audios/respuestas_predefinidas/malvinas/contexto_geografico/03_bandera.mp3';
    }
    if (q === '¬øqui√©n es considerado el fundador de la presencia argentina en malvinas?') {
      return '/audios/respuestas_predefinidas/malvinas/contexto_geografico/04_fundador.mp3';
    }
    if (q === '¬øqui√©n fue el primer gobernador brit√°nico de las malvinas?') {
      return '/audios/respuestas_predefinidas/malvinas/contexto_geografico/05_primer_gobernador.mp3';
    }
    if (q === '¬øqu√© tipos de plantas existen en las islas malvinas?') {
      return '/audios/respuestas_predefinidas/malvinas/contexto_geografico/06_flora.mp3';
    }
    if (q === '¬øqu√© animales habitan en las malvinas?') {
      return '/audios/respuestas_predefinidas/malvinas/contexto_geografico/07_fauna.mp3';
    }
    if (q === '¬øcu√°les son las principales actividades econ√≥micas de las malvinas?') {
      return '/audios/respuestas_predefinidas/malvinas/contexto_geografico/08_actividades_economicas.mp3';
    }
    
    // === MALVINAS - CONFLICTO ARMADO 1982 ===
    
    if (q === '¬øcu√°ndo y c√≥mo comenz√≥ la guerra de malvinas?') {
      return '/audios/respuestas_predefinidas/malvinas/conflicto_armado/09_inicio_conflicto.mp3';
    }
    if (q === '¬øqu√© conflictos destacaron durante la guerra, incluyendo los menos conocidos?') {
      return '/audios/respuestas_predefinidas/malvinas/conflicto_armado/10_conflictos_destacados.mp3';
    }
    if (q === '¬øc√≥mo concluy√≥ la guerra y cu√°l fue la batalla final?') {
      return '/audios/respuestas_predefinidas/malvinas/conflicto_armado/11_conclusion_guerra.mp3';
    }
    if (q === '¬øcu√°l fue el impacto del hundimiento del ara general belgrano?') {
      return '/audios/respuestas_predefinidas/malvinas/conflicto_armado/12_impacto_ARA_General_belgrano.mp3';
    }
    if (q === '¬øqu√© armamento utilizaron argentina y reino unido durante la guerra de malvinas?') {
      return '/audios/respuestas_predefinidas/malvinas/conflicto_armado/13_armamento.mp3';
    }
    if (q === '¬øcu√°l fue el arma m√°s efectiva de argentina?') {
      return '/audios/respuestas_predefinidas/malvinas/conflicto_armado/14_arma_mas_efectiva_Argentina.mp3';
    }
    if (q === '¬øqui√©nes son considerados h√©roes en la guerra de malvinas?') {
      return '/audios/respuestas_predefinidas/malvinas/conflicto_armado/15_heroes_Malvinas.mp3';
    }
    if (q === '¬øcu√°l fue el rol de los pilotos argentinos en el conflicto?') {
      return '/audios/respuestas_predefinidas/malvinas/conflicto_armado/16_rol_pilotos.mp3';
    }
    if (q === '¬øqu√© desaf√≠os enfrentaron los pilotos durante las operaciones?') {
      return '/audios/respuestas_predefinidas/malvinas/conflicto_armado/17_desafios_pilotos.mp3';
    }
    if (q === '¬øcu√°ntas bajas y heridos hubo en ambos bandos durante la guerra?') {
      return '/audios/respuestas_predefinidas/malvinas/conflicto_armado/18_bajas_heridos.mp3';
    }
    if (q === '¬øc√≥mo se financiaron argentina y reino unido durante el conflicto?') {
      return '/audios/respuestas_predefinidas/malvinas/conflicto_armado/19_suministros_economicos.mp3';
    }
    if (q === '¬øhubo sanciones econ√≥micas durante la guerra?') {
      return '/audios/respuestas_predefinidas/malvinas/conflicto_armado/20_sanciones_economicas.mp3';
    }
    // DETECCI√ìN ESPEC√çFICA PARA SECTORES GEOGR√ÅFICOS - FORZADA
    console.log('üîç DEBUG: Verificando pregunta para audio:', q);
    
    if (q.includes('sectores') || q.includes('geogr√°ficos') || q.includes('Sectores') || q.includes('Geogr√°ficos')) {
      console.log('üéØ DETECTADA pregunta sobre sectores geogr√°ficos');
      console.log('üéµ FORZANDO audio: 21_principales_sectores_geogr√°ficos.mp3');
      console.log('üìÅ Intentando ruta: /src/assets/audios/respuestas_predefinidas/malvinas/conflicto_armado/21_principales_sectores_geogr√°ficos.mp3');
      return '/src/assets/audios/respuestas_predefinidas/malvinas/conflicto_armado/21_principales_sectores_geogr√°ficos.mp3';
    }
    
    // Detecci√≥n exacta
    const qLower = q.toLowerCase();
    if (qLower === '¬øcu√°les son los principales sectores geogr√°ficos de las islas malvinas?' || 
        qLower.includes('cu√°les son los principales sectores geogr√°ficos') ||
        qLower.includes('principales sectores geogr√°ficos de las islas malvinas') ||
        qLower.includes('sectores geogr√°ficos de las islas malvinas') ||
        qLower.includes('principales sectores geogr√°ficos')) {
      console.log('üéµ Audio ENCONTRADO para sectores geogr√°ficos:', q);
      console.log('üéµ Ruta del audio: /audios/respuestas_predefinidas/malvinas/conflicto_armado/21_principales_sectores_geogr√°ficos.mp3');
      return '/audios/respuestas_predefinidas/malvinas/conflicto_armado/21_principales_sectores_geogr√°ficos.mp3';
    }
    if (q === '¬øparticiparon perros en la guerra de malvinas?') {
      return '/audios/respuestas_predefinidas/malvinas/conflicto_armado/22_participacion_perros.mp3';
    }
    if (q === '¬øpor qu√© no se menciona su participaci√≥n en muchos relatos hist√≥ricos?') {
      return '/audios/respuestas_predefinidas/malvinas/conflicto_armado/23_relatos_historicos_perros.mp3';
    }
    
    // === MALVINAS - IMPACTO SOCIAL Y CULTURAL ===
    
    if (q === '¬øc√≥mo se informaba sobre la guerra de malvinas en argentina mientras ocurr√≠a?') {
      return '/audios/respuestas_predefinidas/malvinas/impacto_social/24_relato_durante_conflicto.mp3';
    }
    if (q === '¬øqu√© rol jugaron los medios locales frente a la censura nacional?') {
      return '/audios/respuestas_predefinidas/malvinas/impacto_social/25_medios_locales.mp3';
    }
    if (q === '¬øc√≥mo retrataron los peri√≥dicos argentinos la guerra de malvinas?') {
      return '/audios/respuestas_predefinidas/malvinas/impacto_social/26_periodicos_argentinos.mp3';
    }
    if (q === '¬øhubo diferencias entre medios nacionales y regionales?') {
      return '/audios/respuestas_predefinidas/malvinas/impacto_social/27_diferencias_regionales.mp3';
    }
    if (q === '¬øc√≥mo respondi√≥ la sociedad argentina con donaciones durante la guerra?') {
      return '/audios/respuestas_predefinidas/malvinas/impacto_social/28_respuesta_social.mp3';
    }
    if (q === '¬øqu√© simbolizaban estas donaciones para la sociedad?') {
      return '/audios/respuestas_predefinidas/malvinas/impacto_social/29_simbolismo_donaciones.mp3';
    }
    if (q === '¬øc√≥mo participaron los estudiantes argentinos mediante cartas durante la guerra de malvinas?') {
      return '/audios/respuestas_predefinidas/malvinas/impacto_social/30_participacion_estudiantil.mp3';
    }
    if (q === '¬øqu√© simbolizaban estas cartas para los soldados?') {
      return '/audios/respuestas_predefinidas/malvinas/impacto_social/31_simbolismo_soldados.mp3';
    }
    if (q === '¬øqu√© relatos contienen las cartas escritas por veteranos de la guerra?') {
      return '/audios/respuestas_predefinidas/malvinas/impacto_social/32_relatos_veteranos.mp3';
    }
    if (q === '¬øc√≥mo afectaron estas cartas a las familias?') {
      return '/audios/respuestas_predefinidas/malvinas/impacto_social/33_impacto_familias.mp3';
    }
    if (q === '¬øqu√© cartas dejaron los soldados que murieron en combate?') {
      return '/audios/respuestas_predefinidas/malvinas/impacto_social/34_ultimas_cartas.mp3';
    }
    if (q === '¬øc√≥mo se preservan hoy estas cartas?') {
      return '/audios/respuestas_predefinidas/malvinas/impacto_social/35_preservacion_cartas.mp3';
    }
    if (q === '¬øc√≥mo comunicaban los familiares su apoyo a los soldados en malvinas?') {
      return '/audios/respuestas_predefinidas/malvinas/impacto_social/36_comunicacion_apoyo.mp3';
    }
    if (q === '¬øqu√© dificultades enfrentaron para mantener contacto?') {
      return '/audios/respuestas_predefinidas/malvinas/impacto_social/37_dificultades_contacto.mp3';
    }
    
    // === MALVINAS - LEGADO Y REALIDAD ACTUAL ===
    
    if (q === '¬øcu√°l es la situaci√≥n actual de las islas malvinas?') {
      return '/audios/respuestas_predefinidas/malvinas/legado_actual/38_situacion_actual.mp3';
    }
    if (q === '¬øc√≥mo y cu√°ndo se cre√≥ el cementerio de darwin en malvinas?') {
      return '/audios/respuestas_predefinidas/malvinas/legado_actual/39_creacion_cementerio.mp3';
    }
    if (q === '¬øc√≥mo se identificaron los restos de los soldados argentinos en darwin?') {
      return '/audios/respuestas_predefinidas/malvinas/legado_actual/40_identificacion_restos.mp3';
    }
    if (q === '¬øcu√°l es la importancia de la pesca en las islas malvinas?') {
      return '/audios/respuestas_predefinidas/malvinas/legado_actual/41_importancia_economica.mp3';
    }
    if (q === '¬øc√≥mo afecta esto a las relaciones argentino-brit√°nicas?') {
      return '/audios/respuestas_predefinidas/malvinas/legado_actual/42_relaciones_argentino_britanicas.mp3';
    }
    
    // === MAPEO ALTERNATIVO POR PALABRAS CLAVE - MALVINAS ===
    
    // Contexto Geogr√°fico
    if (q.includes('descubrimiento') && q.includes('malvinas')) {
      return '/audios/respuestas_predefinidas/malvinas/contexto_geografico/01_descubrimiento.mp3';
    }
    if (q.includes('historia') && q.includes('malvinas') && q.includes('1982')) {
      return '/audios/respuestas_predefinidas/malvinas/contexto_geografico/02_historia.mp3';
    }
    if (q.includes('bandera') && q.includes('malvinas')) {
      return '/audios/respuestas_predefinidas/malvinas/contexto_geografico/03_bandera.mp3';
    }
    if (q.includes('luis vernet') || (q.includes('fundador') && q.includes('malvinas'))) {
      return '/audios/respuestas_predefinidas/malvinas/contexto_geografico/04_fundador.mp3';
    }
    if (q.includes('primer gobernador') && q.includes('brit√°nico')) {
      return '/audios/respuestas_predefinidas/malvinas/contexto_geografico/05_primer_gobernador.mp3';
    }
    if (q.includes('flora') && q.includes('malvinas')) {
      return '/audios/respuestas_predefinidas/malvinas/contexto_geografico/06_flora.mp3';
    }
    if (q.includes('fauna') && q.includes('malvinas')) {
      return '/audios/respuestas_predefinidas/malvinas/contexto_geografico/07_fauna.mp3';
    }
    if (q.includes('actividades econ√≥micas') && q.includes('malvinas')) {
      return '/audios/respuestas_predefinidas/malvinas/contexto_geografico/08_actividades_economicas.mp3';
    }
    
    // Conflicto Armado
    if (q.includes('guerra') && q.includes('malvinas') && q.includes('comenz√≥')) {
      return '/audios/respuestas_predefinidas/malvinas/conflicto_armado/09_inicio_conflicto.mp3';
    }
    if (q.includes('belgrano') && q.includes('hundimiento')) {
      return '/audios/respuestas_predefinidas/malvinas/conflicto_armado/12_impacto_ARA_General_belgrano.mp3';
    }
    if (q.includes('armamento') && q.includes('malvinas')) {
      return '/audios/respuestas_predefinidas/malvinas/conflicto_armado/13_armamento.mp3';
    }
    if (q.includes('h√©roes') || q.includes('heroes')) {
      return '/audios/respuestas_predefinidas/malvinas/conflicto_armado/15_heroes_Malvinas.mp3';
    }
    if (q.includes('pilotos') && q.includes('rol')) {
      return '/audios/respuestas_predefinidas/malvinas/conflicto_armado/16_rol_pilotos.mp3';
    }
    if (q.includes('bajas') || q.includes('heridos')) {
      return '/audios/respuestas_predefinidas/malvinas/conflicto_armado/18_bajas_heridos.mp3';
    }
    if (q.includes('perros') && q.includes('guerra')) {
      return '/audios/respuestas_predefinidas/malvinas/conflicto_armado/22_participacion_perros.mp3';
    }
    
    // Impacto Social
    if (q.includes('medios') && q.includes('comunicaci√≥n')) {
      return '/audios/respuestas_predefinidas/malvinas/impacto_social/24_relato_durante_conflicto.mp3';
    }
    if (q.includes('peri√≥dicos') && q.includes('argentinos')) {
      return '/audios/respuestas_predefinidas/malvinas/impacto_social/26_periodicos_argentinos.mp3';
    }
    if (q.includes('donaciones') && q.includes('sociedad')) {
      return '/audios/respuestas_predefinidas/malvinas/impacto_social/28_respuesta_social.mp3';
    }
    if (q.includes('cartas') && q.includes('estudiantes')) {
      return '/audios/respuestas_predefinidas/malvinas/impacto_social/30_participacion_estudiantil.mp3';
    }
    if (q.includes('cartas') && q.includes('veteranos')) {
      return '/audios/respuestas_predefinidas/malvinas/impacto_social/32_relatos_veteranos.mp3';
    }
    if (q.includes('cartas') && q.includes('familiares')) {
      return '/audios/respuestas_predefinidas/malvinas/impacto_social/36_comunicacion_apoyo.mp3';
    }
    
    // Legado Actual
    if (q.includes('situaci√≥n actual') && q.includes('malvinas')) {
      return '/audios/respuestas_predefinidas/malvinas/legado_actual/38_situacion_actual.mp3';
    }
    if (q.includes('cementerio') && q.includes('darwin')) {
      return '/audios/respuestas_predefinidas/malvinas/legado_actual/39_creacion_cementerio.mp3';
    }
    if (q.includes('identificaci√≥n') && q.includes('restos')) {
      return '/audios/respuestas_predefinidas/malvinas/legado_actual/40_identificacion_restos.mp3';
    }
    if (q.includes('pesca') && q.includes('malvinas')) {
      return '/audios/respuestas_predefinidas/malvinas/legado_actual/41_importancia_economica.mp3';
    }
    if (q.includes('relaciones') && q.includes('argentino-brit√°nicas')) {
      return '/audios/respuestas_predefinidas/malvinas/legado_actual/42_relaciones_argentino_britanicas.mp3';
    }
    
    // === MAPEO ALTERNATIVO POR PALABRAS CLAVE (SOLO PARA NO-MALVINAS) ===
    
    // Delf√≠n Austral - mapeo alternativo
    if (q.includes('hola') || q.includes('saludo')) {
      return '/audios/respuestas_predefinidas/delfin_austral/01_presentacion.mp3';
    }
    if (q.includes('qu√© eres') || q.includes('que eres')) {
      return '/audios/respuestas_predefinidas/delfin_austral/02_naturaleza.mp3';
    }
    if (q.includes('para qu√©') || q.includes('prop√≥sito') || q.includes('creado')) {
      return '/audios/respuestas_predefinidas/delfin_austral/03_proposito.mp3';
    }
    if (q.includes('puedes hacer') || q.includes('funcionalidades')) {
      return '/audios/respuestas_predefinidas/delfin_austral/04_funcionalidades.mp3';
    }
    
    // Escuela - mapeo alternativo MUY ESPEC√çFICO (evitar conflictos con Malvinas)
    if (!q.includes('malvinas')) {
      if (q.includes('fund√≥') && q.includes('escuela')) {
        return '/audios/respuestas_predefinidas/escuela_secundaria/01_historia_ubicacion.mp3';
      }
      if (q.includes('ubicada') && q.includes('escuela')) {
        return '/audios/respuestas_predefinidas/escuela_secundaria/01_historia_ubicacion.mp3';
      }
      if (q.includes('directivo') || q.includes('director')) {
        return '/audios/respuestas_predefinidas/escuela_secundaria/04_equipo_directivo.mp3';
      }
      if (q.includes('espacios') && q.includes('escuela')) {
        return '/audios/respuestas_predefinidas/escuela_secundaria/05_espacios_educativos.mp3';
      }
    }
    
    // Escuela - mapeo espec√≠fico para "malvinas argentinas" (nombre de la escuela)
    if (q.includes('malvinas argentinas') || q.includes('nombre')) {
      return '/audios/respuestas_predefinidas/escuela_secundaria/02_nombre_proyectos.mp3';
    }
    
    // Museo - mapeo alternativo
    if (q.includes('museo')) {
      if (q.includes('qu√© es') || q.includes('definici√≥n')) {
        return '/audios/respuestas_predefinidas/museo_escolar/01_definicion.mp3';
      }
      if (q.includes('objetivo')) {
        return '/audios/respuestas_predefinidas/museo_escolar/02_objetivos.mp3';
      }
      if (q.includes('actividad')) {
        return '/audios/respuestas_predefinidas/museo_escolar/03_actividades.mp3';
      }
      if (q.includes('recurso')) {
        return '/audios/respuestas_predefinidas/museo_escolar/04_recursos.mp3';
      }
      // Por defecto, si contiene "museo" pero no coincide
      return '/audios/respuestas_predefinidas/museo_escolar/01_definicion.mp3';
    }
    
    console.log('‚ùå No se encontr√≥ audio para:', q);
    return null;
  }

  // üéµ REPRODUCIR AUDIO - Funci√≥n principal
  async play(pregunta, onLoaded = null, onEnded = null) {
    console.log('üéµ AudioManagerFinal: Iniciando reproducci√≥n');
    
    // 0. Verificar que no hay otra reproducci√≥n en curso
    if (this.isPlaying) {
      console.log('‚ö†Ô∏è Ya hay un audio reproduci√©ndose, deteniendo primero');
      this.stopAll();
      await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    // 1. Detener todo primero de forma agresiva
    this.stopAll();
    
    // 2. Obtener ruta de audio
    const audioPath = this.getAudioPath(pregunta);
    if (!audioPath) {
      console.log('‚ùå No hay audio disponible para esta pregunta');
      return null;
    }
    
    console.log('üéµ Reproduciendo:', audioPath);
    
    // 3. Esperar un momento para asegurar limpieza completa
    await new Promise(resolve => setTimeout(resolve, 500));
    
    try {
      // 4. Crear nuevo audio
      this.currentAudio = new Audio(audioPath);
      this.currentAudio.volume = 0.8;
      this.currentAudio.preload = 'auto';
      
      // 5. Configurar eventos
      this.currentAudio.onloadedmetadata = () => {
        console.log(`üéµ Audio cargado - Duraci√≥n: ${this.currentAudio.duration.toFixed(2)}s`);
        this.isPlaying = true;
        if (onLoaded) onLoaded(this.currentAudio.duration);
      };
      
      this.currentAudio.onended = () => {
        console.log('üéµ Audio terminado naturalmente');
        this.currentAudio = null;
        this.isPlaying = false;
        if (onEnded) onEnded();
      };
      
      this.currentAudio.onerror = (error) => {
        console.error('‚ùå Error de audio:', error);
        this.currentAudio = null;
        this.isPlaying = false;
      };
      
      // 6. Guardar referencia global (para compatibilidad)
      window.malvinCurrentAudio = this.currentAudio;
      
      // 7. Reproducir
      await this.currentAudio.play();
      console.log('üéµ ‚úÖ Reproducci√≥n iniciada correctamente');
      
      return this.currentAudio;
      
    } catch (error) {
      console.error('‚ùå Error general reproduciendo audio:', error);
      this.currentAudio = null;
      this.isPlaying = false;
      throw error;
    }
  }

  // üîç Obtener estado actual
  getCurrentAudio() {
    return this.currentAudio;
  }

  getIsPlaying() {
    return this.isPlaying;
  }
}

// Instancia √∫nica
const audioManagerFinal = new AudioManagerFinal();

export default audioManagerFinal;